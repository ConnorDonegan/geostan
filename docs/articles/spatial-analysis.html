<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial analysis with geostan • geostan</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spatial analysis with geostan">
<meta property="og:description" content="geostan">
<meta property="og:image" content="https://connordonegan.github.io/geostan/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ConnorDonegan/geostan/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="spatial-analysis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spatial analysis with geostan</h1>
                        <h4 data-toc-skip class="author">Connor Donegan</h4>
            
            <h4 data-toc-skip class="date">October 29, 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/geostan/blob/HEAD/vignettes/spatial-analysis.Rmd" class="external-link"><code>vignettes/spatial-analysis.Rmd</code></a></small>
      <div class="hidden name"><code>spatial-analysis.Rmd</code></div>

    </div>

    
    
<p><em>This vignette was first publisehd as a post on <a href="https://r-spatial.org/r/2024/08/02/geostan-introduction.html" class="external-link">r-spatial.org</a>.</em></p>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette introduces the <a href="https://connordonegan.github.io/geostan/">geostan</a> R package for spatial analysis. The package is mainly oriented towards areal data, although some models may also be used for other spatial data types, such as network data. The package implements the spatial error/simultaneous spatial autoregressive (SAR) model, conditional autoregressive (CAR) model, and eigenvector spatial filter (ESF) models for spatial regression. A version of ESF modelling also appears in the ecology literature as principle coordinate analysis of neighbor matrices (PCNM) <span class="citation">(Griffith and Peres-Neto <a href="#ref-griffith_2006" role="doc-biblioref">2006</a>)</span>.</p>
<p>geostan also supports the application of the above regression methods to hierarchical models for count data, as is common in analyses of disease incidence or mortality in small areas (‘disease mapping’). Additional features of the software include models for sampling/measurement error in covariates and methods for handling censored count data, such as when mortality or disease counts have been censored for privacy. The models were built using the <a href="https://mc-stan.org/" class="external-link">Stan</a> modeling language, so all inference is completed using Markov chain Monte Carlo (MCMC) sampling <span class="citation">(Stan Development Team <a href="#ref-stan_2023" role="doc-biblioref">2023</a>; Gabry et al. <a href="#ref-gabry_2024" role="doc-biblioref">2024</a>)</span>. The spatial autoregressive models use custom-built Stan functions that speed up MCMC sampling considerably <span class="citation">(Donegan <a href="#ref-donegan_2021" role="doc-biblioref">2021</a>)</span>.</p>
<p>This post will walk through an example analysis using international data on life expectancy and per capita GDP. Package vignettes can be found with the online <a href="https://connordonegan.github.io/geostan/articles/">documentation</a>, including an introduction to spatial weights matrices, exploratory spatial data analysis, spatial measurement error models, raster regression, and using geostan to build custom spatial models with Stan. A paper in the <a href="https://doi.org/10.21105/joss.04716" class="external-link"><em>Journal of Open Source Software</em></a> reports these and other features and provides the recommended citation when using geostan <span class="citation">(Donegan <a href="#ref-donegan_2022" role="doc-biblioref">2022</a>)</span>.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>geostan is currently on CRAN, although that may not always be the case. You can also install directly from geostan’s <a href="https://github.com/ConnorDonegan/geostan" class="external-link">github repository</a>.</p>
<div class="section level3">
<h3 id="from-github">From github<a class="anchor" aria-label="anchor" href="#from-github"></a>
</h3>
<p>You can install from the package github repository:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://devtools.r-lib.org/" class="external-link">'devtools'</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'devtools'</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"connordonegan/geostan"</span><span class="op">)</span></span></code></pre></div>
<p>If you are using Windows and installing using <code>install_github</code>, you may need to install <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">Rtools</a> first. Rtools is not needed when installing from CRAN. You may also contact the author by e-mail for a pre-compiled version that you can use without Rtools.</p>
<p>If you are using Mac and installing with <code>install_github</code> then you may need to install Xcode Command Line Tools first.</p>
</div>
<div class="section level3">
<h3 id="from-cran">From CRAN<a class="anchor" aria-label="anchor" href="#from-cran"></a>
</h3>
<p>Using your R console, you can install from CRAN as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"geostan"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<p>To begin, load the geostan and <code>sf</code> packages into your R environment, as well as the <code>world</code> data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://connordonegan.github.io/geostan/">geostan</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">world</span>, package <span class="op">=</span> <span class="st">"spData"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>world</code> data contains life expectancy and gross domestic product (GDP) per capita (presumably measured in current $US) for 161 countries as of 2014, gathered from the World Bank. The rest of this post is going to be structured around a bivariate analysis of these variables.</p>
<p>We are going to apply the Robinson map projection for the countries:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">world</span>, crs <span class="op">=</span> <span class="st">'ESRI:54030'</span><span class="op">)</span></span></code></pre></div>
<p>At least a couple of the missing values can be filled in using World Bank data, so we will do that:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## https://data.worldbank.org</span></span>
<span><span class="va">france</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"France"</span>, <span class="va">world</span><span class="op">$</span><span class="va">name_long</span><span class="op">)</span></span>
<span><span class="va">world</span><span class="op">$</span><span class="va">gdpPercap</span><span class="op">[</span> <span class="va">france</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">43068</span></span>
<span><span class="va">world</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">[</span> <span class="va">france</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">82</span></span>
<span></span>
<span><span class="va">norway</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Norway"</span>, <span class="va">world</span><span class="op">$</span><span class="va">name_long</span><span class="op">)</span></span>
<span><span class="va">world</span><span class="op">$</span><span class="va">gdpPercap</span><span class="op">[</span> <span class="va">norway</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">97666</span></span>
<span><span class="va">world</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">[</span> <span class="va">norway</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">82.1</span></span></code></pre></div>
<p>And we will also remove Antarctica:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">world</span>, <span class="va">name_long</span> <span class="op">!=</span> <span class="st">"Antarctica"</span><span class="op">)</span></span></code></pre></div>
<p>Mapping the variables shows the familiar geography of high-, middle-, and low-income countries and a similar geography of longevity:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># store geometry for countries</span></span>
<span><span class="va">world_geom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">world</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># show two maps at once, with nice font</span></span>
<span><span class="va">ogpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>             mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># GDP per capita</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">map_pars</span><span class="op">(</span><span class="va">world</span><span class="op">$</span><span class="va">gdpPercap</span> <span class="op">/</span> <span class="fl">1e3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world_geom</span>,</span>
<span>     col <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">col</span>,</span>
<span>     lwd <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomleft"</span>,</span>
<span>       fill <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">pal</span>,</span>
<span>       title <span class="op">=</span> <span class="st">'GDP per capita\n($1,000s)'</span>,</span>
<span>       legend <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">lbls</span>,</span>
<span>       bty <span class="op">=</span> <span class="st">'n'</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># life expectancy</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">map_pars</span><span class="op">(</span><span class="va">world</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world_geom</span>,</span>
<span>  col <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">col</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"left"</span>,</span>
<span>     fill <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">pal</span>,</span>
<span>     title <span class="op">=</span> <span class="st">'Life Expectancy'</span>,</span>
<span>     legend <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">lbls</span>,</span>
<span>     bty <span class="op">=</span> <span class="st">'n'</span></span>
<span>     <span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="spatial-analysis_files/figure-html/unnamed-chunk-8-1.png" alt="*Choropleth maps of GDP per capita and life expectancy.*" width="672"><p class="caption">
<em>Choropleth maps of GDP per capita and life expectancy.</em>
</p>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">ogpar</span><span class="op">)</span></span></code></pre></div>
<p>The <code>map_pars</code> function breaks the variables into quantiles and returns breaks, colors, labels for the maps; it can be found at the end of the post. There will be no discussion of substantive (non-statistical) issues here, for which one can consult any number of texts on global power and inequality (such as Birn, Pillay, and Holz’s <em>Textbook of International Health</em> or Paul Farmer’s <em>Infections and Inequalities</em>).</p>
<p>By conventional methods, the correlation coefficient for life expectancy and log GDP per capita is 0.81:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span> <span class="va">world</span><span class="op">$</span><span class="va">gdpPercap</span> <span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">world</span><span class="op">$</span><span class="va">lifeExp</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html" class="external-link">cor.test</a></span><span class="op">(</span><span class="va">log_x</span>, <span class="va">y</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Pearson's product-moment correlation</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  log_x and y</span></span>
<span><span class="co">## t = 17.394, df = 160, p-value &lt; 2.2e-16</span></span>
<span><span class="co">## alternative hypothesis: true correlation is not equal to 0</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.7478143 0.8561778</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##       cor </span></span>
<span><span class="co">## 0.8087528</span></span></code></pre>
<p>The conventional assessment is based on the proposition that we have 161 independent observations. The visible geography of the variables, and any level of social awareness, indicates that these are not independent observations. Rather, there are various functional regions of countries that share basic political-economic conditions. A lot, but not all, of the variation can be described as variation across continents and regions. We will want to account for this dependence using a spatial model <span class="citation">(for background see Chun and Griffith <a href="#ref-chun_2012" role="doc-biblioref">2012</a>; Donegan <a href="#ref-donegan_2024" role="doc-biblioref">2024</a>)</span>. The first step will be to construct a spatial weights matrix.</p>
</div>
<div class="section level2">
<h2 id="adjacency-matrix">Adjacency matrix<a class="anchor" aria-label="anchor" href="#adjacency-matrix"></a>
</h2>
<p>This section will illustrate use of two geostan functions for creating an revising a spatial weights matrix: <code>shape2mat</code> and <code>edges</code>. The <code>shape2mat</code> function may be helpful for some users but one can always do this using <code>spdep</code> or other methods, especially if <code>shape2mat</code> does not provide the exact method you’re looking for.</p>
<p>We are going to start by removing the 15 countries that are missing values:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## remove missing values</span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">world</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## leaving 162 observations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">world</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 162</span></span></code></pre>
<p>Now we can apply the <code>shape2mat</code> function to obtain an <a href="https://connordonegan.github.io/geostan/articles/spatial-weights-matrix.html">adjacency matrix</a> that encodes spatial adjacency relations for countries into a binary N-by-N matrix. The function uses <code>spdep</code> to find adjacency relations and returns results as a sparse matrix (using the <code>Matrix</code> package):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">world</span>, <span class="st">"B"</span>, method <span class="op">=</span> <span class="st">"rook"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in spdep::poly2nb(shape, queen = queen, snap = snap): some observations have no neighbours;</span></span>
<span><span class="co">## if this seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::poly2nb(shape, queen = queen, snap = snap): neighbour object has 19 sub-graphs;</span></span>
<span><span class="co">## if this sub-graph count seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Contiguity condition: rook</span></span></code></pre>
<pre><code><span><span class="co">## Number of neighbors per unit, summary:</span></span></code></pre>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##   0.000   2.000   3.000   3.605   5.000  13.000</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Spatial weights, summary:</span></span></code></pre>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##       1       1       1       1       1       1</span></span></code></pre>
<p>Visualizing the connections in the matrix is important for uncovering unexpected results. geostan’s <code>edges</code> function converts the matrix into a list of nodes and edges that we can plot. For this we need to supply the function with the adjacency matrix, <code>A</code>, and the associated spatial object, <code>world</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># edges with geometry</span></span>
<span><span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/edges.html">edges</a></span><span class="op">(</span><span class="va">A</span>, shape <span class="op">=</span> <span class="va">world</span><span class="op">)</span> </span>
<span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ogpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># plot countries</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world_geom</span>, lwd <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span>
<span><span class="co"># add graph nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">graph</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'p'</span><span class="op">)</span></span>
<span><span class="co"># add graph edges</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">graph</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-analysis_files/figure-html/unnamed-chunk-12-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">ogpar</span><span class="op">)</span></span></code></pre></div>
<p>This reveals quite a few unexpected results. French Guiana is stored in the <code>world</code> data as part of France (a multi-part polygon); this is correct of course but it leads to Brazil and Suriname being listed as neighbors of France, which is not sensible. Besides removing those connections, there are a number of island nations that we might want to connect to nearby places.</p>
<p>To connect Mozambique to Madagascar, we just replace the zeroes with ones in the slots that correspond to those countries. First we grab their index positions in the matrix:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moz_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Mozambique"</span>, <span class="va">world</span><span class="op">$</span><span class="va">name_long</span><span class="op">)</span></span>
<span><span class="va">mad_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Madagascar"</span>, <span class="va">world</span><span class="op">$</span><span class="va">name_long</span><span class="op">)</span></span></code></pre></div>
<p>And then we assign the correct slots in the matrix a value of 1 (or <code>TRUE</code>), remembering that the adjacency matrix is symmetric:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span><span class="op">[</span><span class="va">moz_idx</span>, <span class="va">mad_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">A</span><span class="op">[</span><span class="va">mad_idx</span>, <span class="va">moz_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
<p>This can become tedious but it is important. Before moving on, we will make a series of adjustments. This will be made a bit easier with this convenience function:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connect</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">country_a</span>, <span class="va">country_b</span>,</span>
<span>    <span class="va">names_vec</span> <span class="op">=</span> <span class="va">world</span><span class="op">$</span><span class="va">name_long</span>, <span class="va">matrix</span> <span class="op">=</span> <span class="va">A</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span> <span class="va">country_a</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">names_vec</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span> <span class="va">country_b</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">names_vec</span> <span class="op">)</span></span>
<span>  <span class="va">a_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">names_vec</span> <span class="op">==</span> <span class="va">country_a</span><span class="op">)</span></span>
<span>  <span class="va">b_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span> <span class="va">names_vec</span> <span class="op">==</span> <span class="va">country_b</span><span class="op">)</span></span>
<span>  <span class="va">matrix</span><span class="op">[</span><span class="va">a_idx</span>, <span class="va">b_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">matrix</span><span class="op">[</span><span class="va">b_idx</span>, <span class="va">a_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">add</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span> <span class="va">matrix</span> <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The following are at least reasonable changes to make; they also ensure that every country has at least one neighbor:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Mozambique"</span>, <span class="st">"Madagascar"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Australia"</span>, <span class="st">"New Zealand"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Philippines"</span>, <span class="st">"Malaysia"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Japan"</span>, <span class="st">"Republic of Korea"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Fiji"</span>, <span class="st">"Vanuatu"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Solomon Islands"</span>, <span class="st">"Vanuatu"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Solomon Islands"</span>, <span class="st">"Papua New Guinea"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Australia"</span>, <span class="st">"Papua New Guinea"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Haiti"</span>, <span class="st">"Jamaica"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Bahamas"</span>, <span class="st">"United States"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Dominican Republic"</span>, <span class="st">"Puerto Rico"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Trinidad and Tobago"</span>, <span class="st">"Venezuela"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Sri Lanka"</span>, <span class="st">"India"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Cyprus"</span>, <span class="st">"Turkey"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Cyprus"</span>, <span class="st">"Lebanon"</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Norway"</span>, <span class="st">"Iceland"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## remove connections between South American and France</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Suriname"</span>, <span class="st">"France"</span>, add <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">connect</span><span class="op">(</span><span class="st">"Brazil"</span>, <span class="st">"France"</span>, add <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We should look at the revised adjacency matrix:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span> <span class="fu"><a href="../reference/edges.html">edges</a></span><span class="op">(</span><span class="va">A</span>, shape <span class="op">=</span> <span class="va">world</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">ogpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world_geom</span>, lwd <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">graph</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'p'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">graph</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-analysis_files/figure-html/unnamed-chunk-17-1.png" width="480" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">ogpar</span><span class="op">)</span></span></code></pre></div>
<p>Sometimes it can help to examine the edge list interactively using a proper geographic information system like QGIS. For those who are familiar with (non-R) GIS software, you can save the edges list as a GeoPackage and then open it up in your GIS to examine the connections ‘by hand’ with a base map or other data:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/edges.html">edges</a></span><span class="op">(</span><span class="va">A</span>, shape <span class="op">=</span> <span class="va">world</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">E</span>, <span class="st">"world.gpkg"</span>, layer <span class="op">=</span> <span class="st">"edge list"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="non-spatial-regression">Non-spatial regression<a class="anchor" aria-label="anchor" href="#non-spatial-regression"></a>
</h2>
<p>Fitting regression models with geostan is similar to using base R’s <code>glm</code> function: the user provides a model formula, data, and the model family or distribution. We can fit a normal linear model using the <code>stan_glm</code> function:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">world</span>, iter <span class="op">=</span> <span class="fl">800</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The <code>iter</code> argument will be discussed below; we used <code>iter = 800</code> (lower than the default) to keep this demo running quickly. We can examine parameter estimates by printing to the console:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_lm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Spatial Model Results </span></span>
<span><span class="co">## Formula: lifeExp ~ log(gdpPercap)</span></span>
<span><span class="co">## Likelihood:  gaussian </span></span>
<span><span class="co">## Link:  identity </span></span>
<span><span class="co">## Spatial method:  none </span></span>
<span><span class="co">## Observations:  162 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Inference for Stan model: foundation.</span></span>
<span><span class="co">## 4 chains, each with iter=800; warmup=400; thin=1; </span></span>
<span><span class="co">## post-warmup draws per chain=400, total post-warmup draws=1600.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                  mean se_mean    sd   2.5%    20%    50%    80%  97.5% n_eff</span></span>
<span><span class="co">## intercept      20.604   0.138 2.999 14.821 18.030 20.689 23.256 26.317   470</span></span>
<span><span class="co">## log(gdpPercap)  5.504   0.015 0.322  4.884  5.231  5.503  5.784  6.118   480</span></span>
<span><span class="co">## sigma           4.904   0.010 0.269  4.429  4.668  4.905  5.115  5.465   750</span></span>
<span><span class="co">##                 Rhat</span></span>
<span><span class="co">## intercept      1.005</span></span>
<span><span class="co">## log(gdpPercap) 1.005</span></span>
<span><span class="co">## sigma          1.001</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Samples were drawn using NUTS(diag_e) at Mon Jul 14 14:15:19 2025.</span></span>
<span><span class="co">## For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">## and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">## convergence, Rhat=1).</span></span></code></pre>
<p>The output printed to the console provides a summary of the posterior probability distributions of the model parameters. The distributions can also be visualized using <code>plot(fit_lm)</code>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_lm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre>
<p><img src="spatial-analysis_files/figure-html/unnamed-chunk-21-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The mean of the distribution is reported in the <code>mean</code> column. For those who are more familiar with concepts from sampling theory, the <code>mean</code> may be understood as the estimate of the parameter. Each distribution’s standard deviation is found in the <code>sd</code> column; this describes the width of the posterior distribution. The <code>sd</code> is analogous to the standard error of the estimate. The quantiles also summarize the width of the posterior distributions; the 2.5% and 97.5% values form a 95% credible interval for the parameter value.</p>
<div class="section level3">
<h3 id="mcmc-output">MCMC output<a class="anchor" aria-label="anchor" href="#mcmc-output"></a>
</h3>
<p>The effective sample size (ESS), <code>n_eff</code>, tells us how many independent MCMC samples the inference is based on after adjusting for serial autocorrelation in the MCMC samples. This is an important quantity to pay attention to and generally one might like to see these numbers above 400 (or around 100 samples per MCMC chain). The standard error of the mean, <code>se_mean</code>, reports how much MCMC sampling error to expect in the <code>mean</code> (<code>se_mean</code> is calculated using <code>n_eff</code>). The R-hat statistic, <code>Rhat</code>, should always be very close to 1, preferably less than 1.01. The R-hat diagnostic tests that the MCMC chains are all depicting the same distribution. If they diverge from one another, it either means that you need to draw a higher number of MCMC samples (run the chains for longer) or that there is a problem fitting the model to your data.</p>
<p>By default, geostan models run four independent MCMC chains for 2,000 iterations each, half of which is discarded as warm-up. The number of iterations is controlled by the <code>iter</code> argument, the default being <code>iter = 2e3</code>. For some models this may be too low and you will want to increase this. Other times this might be <em>more</em> than is needed in which case you can reduce the computation time by using fewer iterations. What matters most is not your number of iterations but your ESS and R-hat statistics. When it comes to reporting results, it is generally best to use at least the default of four MCMC chains (<code>chains = 4</code>).</p>
</div>
<div class="section level3">
<h3 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h3>
<p>A number of familiar methods are available for working with geostan models including <code>fitted</code>, <code>resid</code>, and <code>predict</code>.</p>
<p>The <code>fitted</code> method returns a <code>data.frame</code> with summaries of the fitted values. The probability distribution for each fitted value is summarized by its posterior mean, standard deviation, and quantiles:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit_lm</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fdf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##               mean        sd     2.5%      20%      50%      80%    97.5%</span></span>
<span><span class="co">## fitted[1] 70.22325 0.3958945 69.45245 69.88625 70.22963 70.55043 71.00769</span></span>
<span><span class="co">## fitted[2] 63.45024 0.6101646 62.29326 62.91652 63.46281 63.97594 64.59482</span></span>
<span><span class="co">## fitted[3] 79.33940 0.6008245 78.18550 78.82906 79.33627 79.84760 80.50778</span></span>
<span><span class="co">## fitted[4] 80.36706 0.6477634 79.12126 79.81673 80.36413 80.91975 81.63142</span></span>
<span><span class="co">## fitted[5] 76.02402 0.4701727 75.08544 75.62760 76.02202 76.42606 76.91284</span></span>
<span><span class="co">## fitted[6] 67.87923 0.4426079 67.02744 67.50195 67.88025 68.25438 68.74189</span></span></code></pre>
<p>The <code>resid</code> method behaves similarly. Examining the Moran scatter plot using the residuals shows a moderate degree of positive SA as well as some skewness:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="va">fit_lm</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/moran_plot.html">moran_plot</a></span><span class="op">(</span><span class="va">rdf</span><span class="op">$</span><span class="va">mean</span>, <span class="va">A</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-analysis_files/figure-html/unnamed-chunk-23-1.png" width="432" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="spatial-regression">Spatial regression<a class="anchor" aria-label="anchor" href="#spatial-regression"></a>
</h2>
<p>Options for spatial regression models currently include conditional autoregressive (CAR), simultaneous autoregressive (SAR/spatial error), and eigenvector spatial filtering (ESF). For count data, common variations on the intrinsic autoregressive (ICAR) model are also available.</p>
<p>All of the spatial models require at least a spatial weights matrix as input. All additional requirements for data preparation are handled by geostan’s <code>prep_</code> functions: <code>prep_car_data</code>, <code>prep_icar_data</code>, <code>prep_sar_data</code>.</p>
<p>The <code>make_EV</code> function is used to create Moran’s eigenvectors for ESF regression; if you want to create your own eigenvectors (say, following the PCNM method) you can provide those directly to the ESF model (see <code><a href="../reference/stan_esf.html">?stan_esf</a></code>).</p>
<p>For the CAR model, we always provide the binary adjacency matrix as input to <code>prep_car_data</code>. See the <code>prep_car_data</code> documentation for options. Here we will fit an intercept-only CAR model to the life expectancy data:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep_car_data.html">prep_car_data</a></span><span class="op">(</span><span class="va">A</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">fit_car</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_car.html">stan_car</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">world</span>, car_parts <span class="op">=</span> <span class="va">cars</span>, iter <span class="op">=</span> <span class="fl">800</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_car</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Spatial Model Results </span></span>
<span><span class="co">## Formula: lifeExp ~ 1</span></span>
<span><span class="co">## Likelihood:  auto_gaussian </span></span>
<span><span class="co">## Link:  identity </span></span>
<span><span class="co">## Spatial method:  CAR </span></span>
<span><span class="co">## Residual Moran Coefficient:  -0.3562562 </span></span>
<span><span class="co">## Observations:  162 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Inference for Stan model: foundation.</span></span>
<span><span class="co">## 4 chains, each with iter=800; warmup=400; thin=1; </span></span>
<span><span class="co">## post-warmup draws per chain=400, total post-warmup draws=1600.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             mean se_mean    sd   2.5%    20%    50%    80%  97.5% n_eff  Rhat</span></span>
<span><span class="co">## intercept 70.004   0.106 2.954 63.824 67.821 69.985 72.144 75.824   771 1.003</span></span>
<span><span class="co">## car_rho    0.981   0.000 0.011  0.955  0.973  0.983  0.990  0.996   821 1.004</span></span>
<span><span class="co">## car_scale  7.838   0.015 0.466  7.008  7.446  7.809  8.230  8.835   932 0.999</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Samples were drawn using NUTS(diag_e) at Mon Jul 14 14:15:27 2025.</span></span>
<span><span class="co">## For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">## and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">## convergence, Rhat=1).</span></span></code></pre>
<p>Notice that using <code>iter = 1000</code> was more than adequate for inference in this case.</p>
<p>The CAR model has a spatial dependence parameter <code>car_rho</code>. This parameter does <em>not</em> have an interpretation similar to a correlation coefficient, and it is often near 1; this is not a problem unless one misinterprets it or desires a value similar to the correlation coefficient. The spatial dependence parameter in the SAR model does provide that kind of interpretation.</p>
<div class="section level3">
<h3 id="a-filtering-approach">A filtering approach<a class="anchor" aria-label="anchor" href="#a-filtering-approach"></a>
</h3>
<p>Returning to the correlation coefficient estimated above, one way to adjust our estimate for spatial dependence is to filter out the spatial trend from each of the two variables and then calculate the correlation coefficient using the detrended values <span class="citation">(Chun and Griffith <a href="#ref-chun_2012" role="doc-biblioref">2012</a>, 71)</span>. This spatial ‘filtering’ or ‘pre-whitening’ method is not particularly common in practice but its a good trick to know given the familiarity of the correlation coefficient. We will use it here to demonstrate some basic features of the software.</p>
<p>The spatial trend term can be extracted from any spatial geostan model using the <code>spatial</code> method.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/resid_geostan_fit.html">spatial</a></span><span class="op">(</span><span class="va">fit_car</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">map_pars</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">ogpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">world</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">col</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"left"</span>,</span>
<span>     fill <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">pal</span>,</span>
<span>     title <span class="op">=</span> <span class="st">'Spatial trend (LE)'</span>,</span>
<span>     legend <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">lbls</span>,</span>
<span>     bty <span class="op">=</span> <span class="st">'n'</span></span>
<span>     <span class="op">)</span></span></code></pre></div>
<p><img src="spatial-analysis_files/figure-html/unnamed-chunk-27-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">ogpar</span><span class="op">)</span></span></code></pre></div>
<p>We can obtain detrended values most simply by taking the residuals from an intercept-only spatial model:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lifeExpt detrended</span></span>
<span><span class="va">dy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="va">fit_car</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span></span>
<span></span>
<span><span class="co"># log per capita GDP detrended</span></span>
<span><span class="va">fit_carx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_car.html">stan_car</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">world</span>, car <span class="op">=</span> <span class="va">cars</span>, iter <span class="op">=</span> <span class="fl">1e3</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="va">fit_carx</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span></span></code></pre></div>
<p>Using <code>cor.test</code> with those provides an estimate of correlation adjusted for spatial autocorrelation:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># adjusted correlation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html" class="external-link">cor.test</a></span><span class="op">(</span><span class="va">dx</span>, <span class="va">dy</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Pearson's product-moment correlation</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  dx and dy</span></span>
<span><span class="co">## t = 9.1402, df = 160, p-value = 2.692e-16</span></span>
<span><span class="co">## alternative hypothesis: true correlation is not equal to 0</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.4743306 0.6785997</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##      cor </span></span>
<span><span class="co">## 0.585689</span></span></code></pre>
<p>The adjusted estimate of .59 is considerably different from the naive estimate of .80 and is outside the naive confidence intervals. (The adjusted estimate is .62 if we use SAR models.)</p>
</div>
<div class="section level3">
<h3 id="a-bivariate-model">A bivariate model<a class="anchor" aria-label="anchor" href="#a-bivariate-model"></a>
</h3>
<p>Here we will use the SAR model to illustrate its use. Fitting the spatial error or SAR model requires nearly the same steps as above.</p>
<p>Unlike <code>prep_car_data</code>, be sure to row-standardize the adjacency matrix before passing it to <code>prep_sar_data</code>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/row_standardize.html">row_standardize</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="va">sars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep_sar_data.html">prep_sar_data</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span></span></code></pre></div>
<p>When fitting the model, we are going to add <code>centerx = TRUE</code> to center the covariate. (Internally this will call <code>center(x, center = TRUE, scale = FALSE)</code>.) This will not change coefficient estimates but it does often improve MCMC sampling efficiency, sometimes considerably so. It does change interpretation of the intercept: the intercept will be an estimate of the average life expectancy (or the expected life expectancy when all covariates are at their average values).</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_sar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_sar.html">stan_sar</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">world</span>, sar_parts <span class="op">=</span> <span class="va">sars</span>, centerx <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    iter <span class="op">=</span> <span class="fl">800</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Lets plot the results this time:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_sar</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre>
<p><img src="spatial-analysis_files/figure-html/unnamed-chunk-32-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The spatial dependence parameter is around 0.7, which indicates moderately strong SA. The mean life expectancy is about 71 (probably somewhere between about 69 and 74). And the coefficient for log GDP is around 4 (or somewhere between 3 and 5). The residual variation has a standard deviation of around 3.6 years.</p>
<p>If we scale both variables before fitting the bivariate spatial regression model (so that their variances both equal 1) then we get approximately the same estimate as the adjusted correlation coefficient (above). The credible interval is slightly wider because uncertainty in rho is (appropriately) incorporated here:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">world</span>,</span>
<span>                  sx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span>, scale <span class="op">=</span> <span class="cn">T</span>, center <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>                  sy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">lifeExp</span>, scale <span class="op">=</span> <span class="cn">T</span>, center <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span></span>
<span><span class="va">fit_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_sar.html">stan_sar</a></span><span class="op">(</span><span class="va">sy</span> <span class="op">~</span> <span class="va">sx</span>, data <span class="op">=</span> <span class="va">world</span>, sar_parts <span class="op">=</span> <span class="va">sars</span>, iter <span class="op">=</span> <span class="fl">800</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_scaled</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Spatial Model Results </span></span>
<span><span class="co">## Formula: sy ~ sx</span></span>
<span><span class="co">## Likelihood:  auto_gaussian </span></span>
<span><span class="co">## Link:  identity </span></span>
<span><span class="co">## Spatial method:  SAR (SEM) </span></span>
<span><span class="co">## Residual Moran Coefficient:  -0.05218188 </span></span>
<span><span class="co">## Observations:  162 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Inference for Stan model: foundation.</span></span>
<span><span class="co">## 4 chains, each with iter=800; warmup=400; thin=1; </span></span>
<span><span class="co">## post-warmup draws per chain=400, total post-warmup draws=1600.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            mean se_mean    sd   2.5%    20%   50%   80% 97.5% n_eff  Rhat</span></span>
<span><span class="co">## intercept 0.025   0.003 0.120 -0.217 -0.066 0.023 0.116 0.266  1277 1.006</span></span>
<span><span class="co">## sx        0.587   0.002 0.062  0.472  0.533 0.586 0.640 0.710  1331 1.000</span></span>
<span><span class="co">## sar_rho   0.699   0.002 0.059  0.573  0.651 0.701 0.750 0.803  1144 0.999</span></span>
<span><span class="co">## sar_scale 0.437   0.001 0.026  0.390  0.415 0.436 0.459 0.492  1220 0.999</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Samples were drawn using NUTS(diag_e) at Mon Jul 14 14:16:00 2025.</span></span>
<span><span class="co">## For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">## and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">## convergence, Rhat=1).</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="predicted-values">Predicted values<a class="anchor" aria-label="anchor" href="#predicted-values"></a>
</h3>
<p>We can visualize the model results by plotting the expected life expectancy across the full range of GDP per capita. We use the <code>predict</code> function for this. As input, it requires our fitted model and a <code>data.frame</code> with covariate values.</p>
<p>We will start by creating a <code>data.frame</code> with GDP per capita values that span from the minimum to maximum values in the <code>world</code> data:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">world</span><span class="op">$</span><span class="va">gdpPercap</span><span class="op">)</span></span>
<span><span class="va">min_gdp</span> <span class="op">&lt;-</span> <span class="va">gdp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">max_gdp</span> <span class="op">&lt;-</span> <span class="va">gdp</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">pdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>gdpPercap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">min_gdp</span>, <span class="va">max_gdp</span>, length.out <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The column names in this <code>data.frame</code> have to match the variable names that were present in the data that we first provided to the model. In this case, the name of the columns should match those from the <code>world</code> data. Likewise, we provide the new GDP data on its original (un-transformed) scale, just as we did when we fit the model using <code>stan_sar</code> (the log transformation will be applied by <code>predict</code> because it is specified in the model formula). Because we centered the covariate using the <code>centerx = TRUE</code> argument, we will also allow the <code>predict</code> function to handle the centering automatically using information that is stored with the fitted model (<code>stan_sar$x_center</code>).</p>
<p>Now we pass this new data to <code>predict</code>:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_sar</span>, newdata <span class="op">=</span> <span class="va">pdf</span><span class="op">)</span></span></code></pre></div>
<p>The output includes our <code>pdf</code> data plus some new columns. The new columns provide a summary of the predicted values. As usual, the <code>mean</code> is the estimate and the estimate is accompanied by other values that can be used to taken as credible intervals for the predicted value. The output reflects uncertainty in the model parameter estimates.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   gdpPercap     mean       sd     2.5%      20%      50%      80%    97.5%</span></span>
<span><span class="co">## 1  597.1352 60.05924 1.474594 57.22301 58.81170 60.05034 61.28628 63.00565</span></span>
<span><span class="co">## 2 1201.4715 62.86746 1.273016 60.45584 61.78921 62.86513 63.91677 65.47167</span></span>
<span><span class="co">## 3 1805.8079 64.50406 1.171905 62.27963 63.50567 64.49783 65.44192 66.87742</span></span>
<span><span class="co">## 4 2410.1442 65.66356 1.109909 63.51947 64.73907 65.66338 66.54524 67.93013</span></span>
<span><span class="co">## 5 3014.4805 66.56223 1.068398 64.51293 65.68259 66.56718 67.41829 68.72948</span></span>
<span><span class="co">## 6 3618.8169 67.29613 1.039267 65.28355 66.43785 67.30302 68.13103 69.44982</span></span></code></pre>
<p>These ‘predicted’ values represent the expectation of the outcome variable at the given level of the covariates. So we would expect actual observations to form a cloud of points around the ‘predicted’ values. To calculate these predicted values, the <code>predict</code> function only includes covariates and the intercept, it does not include any spatial autocorrelation components. Its purpose is mainly to examine implications of the coefficient estimates on recognizable scales of variation, not to predict values for particular places. (The log-linear model can also be interpreted in terms of percent changes in the covariate, such as ’a 10% increase in GDP per capita, e.g., from 10,000 to 11,000, is associated with around 4 * log(11/10) = 0.38 additional years of life expectancy on average.)</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scale GDP</span></span>
<span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">preds</span>, gdpPercap <span class="op">=</span> <span class="va">gdpPercap</span> <span class="op">/</span> <span class="fl">1e3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## yrange &lt;- c(min(preds$`2.5%`), max(preds$`97.5%`))</span></span>
<span><span class="va">yrange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">57</span>, <span class="fl">85</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">gdpPercap</span>, <span class="va">preds</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>     t <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>     ylim <span class="op">=</span> <span class="va">yrange</span>,</span>
<span>     axes <span class="op">=</span> <span class="cn">F</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"GDP per capita ($1,000s)"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Life expectancy"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add credible intervals</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">gdpPercap</span>, <span class="va">preds</span><span class="op">$</span><span class="va">`2.5%`</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">gdpPercap</span>, <span class="va">preds</span><span class="op">$</span><span class="va">`97.5%`</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># show actual gdp values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/rug.html" class="external-link">rug</a></span><span class="op">(</span><span class="va">world</span><span class="op">$</span><span class="va">gdpPercap</span> <span class="op">/</span> <span class="fl">1e3</span>, lwd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-analysis_files/figure-html/unnamed-chunk-37-1.png" width="432" style="display: block; margin: auto;"></p>
<p>Per this dataset, about 50% of the world population lives in countries with GDP per capita below $12,300.</p>
</div>
</div>
<div class="section level2">
<h2 id="future-work-and-support">Future work and support<a class="anchor" aria-label="anchor" href="#future-work-and-support"></a>
</h2>
<p>You can submit any questions, requests, or issues on the package <a href="https://github.com/connordonegan/geostan/issues" class="external-link">issues page</a> or the <a href="https://github.com/connordonegan/geostan/discussions" class="external-link">discussions page</a>. geostan is still actively being developed so users are encouraged to check the package <a href="https://connordonegan.github.io/geostan/news/">news page</a> for updates.</p>
<p>If you are interesting contributing to the package you are encouraged to send an e-mail to the author or use the discussions page. You can submit a pull request with any bug fixes. Contributions that would make the package more useful to fields other than geostan’s current focus (human geography and public health), such as ecology, would be especially welcome.</p>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function for getting colors, breaks, and labels for mapping</span></span>
<span><span class="va">map_pars</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                     <span class="va">brks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                     <span class="va">cols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#A8554EFF"</span>, <span class="st">"gray95"</span>, <span class="st">"#5D74A5FF"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># put x values into bins</span></span>
<span>  <span class="va">x_cut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">x</span>, breaks <span class="op">=</span> <span class="va">brks</span>, include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># labels for each bin</span></span>
<span>  <span class="va">lbls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">brks</span>, include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># colors </span></span>
<span>  <span class="va">rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span> <span class="va">x_cut</span> <span class="op">)</span>  </span>
<span>  <span class="va">max_rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span> <span class="va">rank</span> , na.rm <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span>  <span class="va">pal_fun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span> <span class="va">cols</span> <span class="op">)</span></span>
<span>  <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">pal_fun</span><span class="op">(</span> <span class="va">max_rank</span> <span class="op">)</span></span>
<span>  <span class="va">colors</span> <span class="op">&lt;-</span>  <span class="va">pal</span><span class="op">[</span> <span class="va">rank</span> <span class="op">]</span></span>
<span></span>
<span>  <span class="co"># return list</span></span>
<span>  <span class="va">ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>brks <span class="op">=</span> <span class="va">brks</span>, lbls <span class="op">=</span> <span class="va">lbls</span>, pal <span class="op">=</span> <span class="va">pal</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span> <span class="va">ls</span> <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-chun_2012">
<p>Chun, Yongwan, and Daniel A Griffith. 2012. “Spatial Statistics and Geostatistics: Theory and Applications for Geographic Information Science and Technology.”</p>
</div>
<div id="ref-donegan_2021">
<p>Donegan, Connor. 2021. “Building Spatial Conditional Autoregressive (CAR) Models in the Stan Programming Language.” <a href="https://osf.io/3ey65/" class="external-link">https://osf.io/3ey65/</a>.</p>
</div>
<div id="ref-donegan_2022">
<p>———. 2022. “Geostan: An R Package for Bayesian Spatial Analysis.” <em>Journal of Open Source Software</em> 7 (79): 4716. <a href="https://doi.org/10.21105/joss.04716" class="external-link">https://doi.org/10.21105/joss.04716</a>.</p>
</div>
<div id="ref-donegan_2024">
<p>———. 2024. “Plausible Reasoning and Spatial-Statistical Theory: A Critique of Recent Writings on ‘Spatial Confounding’.” <em>Geographical Analysis</em> Early view. <a href="https://doi.org/10.1111/gean.12408" class="external-link">https://doi.org/10.1111/gean.12408</a>.</p>
</div>
<div id="ref-gabry_2024">
<p>Gabry, Jonah, Ben Goodrich, Martin Lysy, and Andrew Johnson. 2024. <em>Rstantools: Tools for Developing R Packages Interfacing with ’Stan’</em>. <a href="https://CRAN.R-project.org/package=rstantools" class="external-link">https://CRAN.R-project.org/package=rstantools</a>.</p>
</div>
<div id="ref-griffith_2006">
<p>Griffith, Daniel A, and Pedro R Peres-Neto. 2006. “Spatial Modeling in Ecology: The Flexibility of Eigenfunction Spatial Analyses.” <em>Ecology</em> 87 (10): 2603–13.</p>
</div>
<div id="ref-stan_2023">
<p>Stan Development Team. 2023. <em>Stan User’s Guide</em>. <a href="https://mc-stan.org" class="external-link">https://mc-stan.org</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
