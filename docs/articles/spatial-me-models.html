<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with American Community Survey data • geostan</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Working with American Community Survey data">
<meta property="og:description" content="geostan">
<meta property="og:image" content="https://connordonegan.github.io/geostan/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116873024-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116873024-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/measuring-sa.html">Measuring and visualizing spatial autocorrelation</a>
    </li>
    <li>
      <a href="../articles/spatial-me-models.html">Working with American Community Survey data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ConnorDonegan/geostan/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with American Community Survey data</h1>
                        <h4 class="author">Connor Donegan</h4>
            
            <h4 class="date">September 13, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/geostan/blob/master/vignettes/spatial-me-models.Rmd"><code>vignettes/spatial-me-models.Rmd</code></a></small>
      <div class="hidden name"><code>spatial-me-models.Rmd</code></div>

    </div>

    
    
<p>This vignette introduces users to the spatial measurement error (ME) models implemented in the <strong>geostan</strong> package <span class="citation">(Donegan, Chun, and Griffith <a href="#ref-donegan_2021">2021</a>)</span>. These models are particularly appropriate for working with American Community Survey (ACS) data and other large, government-backed surveys.</p>
<p>A premise of this methodology is that the survey includes a systematic spatial sampling design (i.e., the sampling procedure was stratified by areal unit, whether they be block groups, counties, or states).</p>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>From the R console, load the <strong>geostan</strong>, <strong>sf</strong>, and <strong>tidyverse</strong> packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://connordonegan.github.io/geostan/">geostan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">)</span></code></pre></div>
<p>The line <code><a href="https://rdrr.io/r/utils/data.html">data(georgia)</a></code> loads the <code>georgia</code> data set from the <strong>geostan</strong> package into your working environment. You can learn more about the data by entering <code><a href="../reference/georgia.html">?georgia</a></code> to the R console.</p>
<p>This vignette will make use of the index of concentration at the extremes (<code>ICE</code>) <span class="citation">(Massey <a href="#ref-massey_2001">2001</a>)</span>. The ICE is the difference between the proportion of the population residing in a high income households and the proportion in low income households: <span class="math display">\[\text{ICE} = \text{Proportion Rich} - \text{Proportion Poor,}\]</span> where “rich” and “poor” are defined as the top and bottom quintiles of the US household income distribution (<span class="math inline">\(&lt; \$20,000\)</span> and <span class="math inline">\(&gt;= \$120,000\)</span>), respectively. It ranges from -1, for an entirely impoverished population, to 1, for an entirely wealthy population.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">$</span><span class="va">ICE</span>, <span class="va">georgia</span>, name <span class="op">=</span> <span class="st">"ICE"</span>, style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;"></p>
<p>In this vignette, we will examine the ICE standard errors and build a probability model for the actual ICE values. The purpose of the vignette is provide a guide to critically evaluating both your data and the ME model.</p>
</div>
<div id="examining-survey-standard-errors" class="section level2">
<h2 class="hasAnchor">
<a href="#examining-survey-standard-errors" class="anchor"></a>Examining survey standard errors</h2>
<p>Since the ICE is a composite variable, its standard errors were created using the Census Bureau’s variance replicate tables <span class="citation">(United States Census Bureau <a href="#ref-census_2019">2019</a>)</span>. Examining the standard errors directly is informative, but not quite enlightening:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">$</span><span class="va">ICE.se</span>, <span class="va">georgia</span>, name <span class="op">=</span> <span class="st">"SE(ICE)"</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Their small magnitude may be deceptive because the ICE has small range. How much variation is there in the ICE estimates?</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sd.ice</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">$</span><span class="va">ICE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.126393</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mad.ice</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html">mad</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">$</span><span class="va">ICE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.09241624</code></pre>
<p>For continuous measures like the ICE, it is helpful to scale the standard errors by the scale of the data. Using the median absolute deviation (MAD) is a good option:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scaled_se</span> <span class="op">&lt;-</span> <span class="va">georgia</span><span class="op">$</span><span class="va">ICE.se</span> <span class="op">/</span> <span class="va">mad.ice</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">scaled_se</span><span class="op">)</span>,
                 col <span class="op">=</span> <span class="st">'gray50'</span>,
                binwidth <span class="op">=</span> <span class="fl">0.05</span>
                 <span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-5-1.png" width="336" style="display: block; margin: auto;"> No we can see that the amount of uncertainty in the estimates is substantive; a number of these estimates are not particularly reliable. We can also see there are strong spatial patterns in the reliability of the estimates.</p>
</div>
<div id="modeling-errors-of-observation" class="section level2">
<h2 class="hasAnchor">
<a href="#modeling-errors-of-observation" class="anchor"></a>Modeling errors of observation</h2>
<p>The unknown errors, <span class="math inline">\(\delta_i\)</span>, are defined as the difference between the survey estimate, <span class="math inline">\(z_i\)</span>, and the actual value that would have been obtained by an accurate census taken over the same time period, <span class="math inline">\(x_i\)</span>: <span class="math display">\[\delta_i = z_i - x_i.\]</span> For present purposes, we will take for granted the high quality of the Census Bureau’s systematic spatial sampling design <span class="citation">(on spatial sampling, see Chun and Griffith <a href="#ref-chun_2013">2013</a>)</span>, and thus, we do not expect there to be any spatial pattern to the errors, <span class="math inline">\(\delta_i\)</span>.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<p>Using Bayes’ theorem and the information at our disposal, we can create a probability distribution for these errors. Since <span class="math inline">\(\delta_i\)</span> is a simple function of <span class="math inline">\(z_i\)</span> and <span class="math inline">\(x_i\)</span>), we need to reason about <span class="math display">\[p(\boldsymbol x | \boldsymbol z, \mathcal M),\]</span> where <span class="math inline">\(\mathcal M\)</span> represents our relevant background knowledge. <span class="math inline">\(\mathcal M\)</span> includes the standard errors, <span class="math inline">\(\boldsymbol s\)</span>, as well as the premise that this data was collected using a valid spatial sampling design.</p>
<p>By Bayes’ theorem: <span class="math display">\[\begin{equation}
\begin{split} 
  p(\boldsymbol x | \boldsymbol z, \mathcal M) &amp;\propto p(\boldsymbol z | \boldsymbol x, \mathcal M) p(\boldsymbol x | \mathcal M)   \\
   &amp;\propto \text{Likelihood} \times \text{prior}
   \end{split}
\end{equation}\]</span></p>
<p>The ME models implemented in <strong>geostan</strong> are hierarchical Bayesian models (HBMs) that incorporate two sources of information: a sampling distribution for the survey estimates, and generic background knowledge on social variables. The former is a likelihood statement that states: for a given true value, <span class="math inline">\(x_i\)</span>, and standard error, <span class="math inline">\(s_i\)</span>, the probability of obtaining survey estimate <span class="math inline">\(z_i\)</span> is <span class="math display">\[z_i \sim Gauss(x_i, s_i).\]</span> This reflects the statement that <span class="math inline">\(\delta_i\)</span> are not systematically patterned, and it is consistent with conventional ‘margins of error’ for survey estimates.</p>
<p>The relevant background knowledge includes our basic understanding of contemporary social inequality, particularly that extreme values are not implausible, as well as our knowledge that social variables tend to be spatially patterned, such that extreme values tend to be clustered together. This information is encoded into a probability distribution for the unknown set of values, <span class="math inline">\(\boldsymbol x\)</span>, using the conditional autoregressive (CAR) model: <span class="math display">\[ \boldsymbol x \sim Gauss(\mu \cdot \boldsymbol 1, \Sigma). \]</span> This is a multivariate normal distribution with a constant mean, <span class="math inline">\(\mu\)</span>, and covariance matrix <span class="math display">\[\boldsymbol \Sigma = (I - \rho C)^{-1} M .\]</span> <span class="math inline">\(\Sigma\)</span> contains the spatial connectivity matrix, <span class="math inline">\(\boldsymbol C\)</span>. <span class="math inline">\(M\)</span> is a diagonal matrix that contains the scale parameter, <span class="math inline">\(\tau^2\)</span>, multiplied by given constant terms. There are numerous ways to specify <span class="math inline">\(C\)</span> and <span class="math inline">\(M\)</span> with the CAR model (see <code><a href="../reference/prep_car_data.html">geostan::prep_car_data</a></code>).</p>
<p>The parameters <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\rho\)</span>, and <span class="math inline">\(\tau\)</span> all require prior probability distributions; <strong>geostan</strong> uses the following by default: <span class="math display">\[\begin{equation} 
\begin{split}
\mu &amp;\sim Gauss(0, 100) \\
\tau &amp;\sim Student_t(10, 0, 40) \\
\rho &amp;\sim Uniform(\text{lower_bound}, \text{upper_bound})
\end{split}
\end{equation}\]</span></p>
<p>The default prior for <span class="math inline">\(\rho\)</span> is uniform across its entire support (determined by the extreme eigenvalues of <span class="math inline">\(C\)</span>).</p>
</div>
<div id="me-models-in-geostan" class="section level2">
<h2 class="hasAnchor">
<a href="#me-models-in-geostan" class="anchor"></a>ME models in <strong>geostan</strong>
</h2>
<p>These ME models can be implemented using any of the <strong>geostan</strong> model fitting functions (<code>stan_glm</code>, <code>stan_car</code>, <code>stan_esf</code>, and <code>stan_icar</code>). These functions have a formula interface, so that the basic user experience is similar to using <code>base::glm</code>. For example, if we were to fit a linear model to the log-mortality rates, we could start with the following code:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span> <span class="op">~</span> <span class="va">ICE</span>, data <span class="op">=</span> <span class="va">georgia</span><span class="op">)</span></code></pre></div>
<p>For now, we are just going to use <code>stan_glm</code> to set up our ME models. To tell <code>stan_glm</code> to ignore the outcome data, we add <code>prior_only = TRUE</code> to our call to <code>stan_glm</code>, as demonstrated below.</p>
<p>First, we need to build a list containing all the data required for the ME model. This includes a <code>data.frame</code> with standard errors and data for the CAR model (<span class="math inline">\(C\)</span>, <span class="math inline">\(M\)</span>, and related information required by Stan):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># use binary weights matrix for prep_car_data</span>
<span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">georgia</span>, style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>
<span class="va">cp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep_car_data.html">prep_car_data</a></span><span class="op">(</span><span class="va">C</span>, style <span class="op">=</span> <span class="st">"WCAR"</span><span class="op">)</span></code></pre></div>
<pre><code>## Range of permissible rho values:  -1.661134 1</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ICE <span class="op">=</span> <span class="va">georgia</span><span class="op">$</span><span class="va">ICE.se</span><span class="op">)</span>,
  car_parts <span class="op">=</span> <span class="va">cp</span>
<span class="op">)</span></code></pre></div>
<p>When using <code>prep_car_data</code>, provide a binary weights matrix (not row-standardized!). Finally, we have to remember that the ICE can only range from -1 to 1. To add this information to the model, we add an element to our <code>ME</code> list named <code>bounds</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME</span><span class="op">$</span><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>As indicated, <strong>geostan</strong> will use its default priors if none are provided. The following code demonstrates setting custom priors for <span class="math inline">\(\mu\)</span> (location) and <span class="math inline">\(\tau\)</span> (scale), which should be done (and should be done with care; see <code><a href="../reference/stan_glm.html">?stan_glm</a></code> for details):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME</span><span class="op">$</span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">0</span>,
                                       scale <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,
                 scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">10</span>,
                                    location <span class="op">=</span> <span class="fl">0</span>,
                                    scale <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Note that these priors are weak relative to the natural constraints on the ICE. Since the ICE has extreme values of -1 and 1, the mean can only be found within that range. We would be shocked if the mean ICE were near either of those extremes!</p>
<p>To sample from our spatial ME model, we pass our list of <code>ME</code> data to <code>stan_glm</code> and (for the sake of efficiency) use <code>prior_only = TRUE</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span> <span class="op">~</span> <span class="va">ICE</span>, data <span class="op">=</span> <span class="va">georgia</span>, ME <span class="op">=</span> <span class="va">ME</span>, prior_only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## ----
## *Setting prior parameters for measurement error models</code></pre>
<pre><code>## *CAR spatial autocorrelation parameter (rho)
## Uniform</code></pre>
<pre><code>##   minimum   maximum 
## -1.661134  1.000000</code></pre>
<pre><code>## ----</code></pre>
<pre><code>## 
## *Setting prior parameters for intercept</code></pre>
<pre><code>## Gaussian</code></pre>
<pre><code>##  location     scale 
## -4.169701  5.000000</code></pre>
<pre><code>## 
## *Setting prior parameters for beta
## Gaussian</code></pre>
<pre><code>##     Location Scale
## ICE        0     5</code></pre>
<pre><code>## 
## *Setting prior parameters for sigma</code></pre>
<pre><code>## Student's t</code></pre>
<pre><code>##       df location    scale 
##       10        0        3 
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0.000126 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.26 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 1.71093 seconds (Warm-up)
## Chain 1:                1.22072 seconds (Sampling)
## Chain 1:                2.93165 seconds (Total)
## Chain 1: 
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 2).
## Chain 2: 
## Chain 2: Gradient evaluation took 9.6e-05 seconds
## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.96 seconds.
## Chain 2: Adjust your expectations accordingly!
## Chain 2: 
## Chain 2: 
## Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 2: 
## Chain 2:  Elapsed Time: 1.60501 seconds (Warm-up)
## Chain 2:                1.2551 seconds (Sampling)
## Chain 2:                2.86011 seconds (Total)
## Chain 2: 
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 3).
## Chain 3: 
## Chain 3: Gradient evaluation took 0.000162 seconds
## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.62 seconds.
## Chain 3: Adjust your expectations accordingly!
## Chain 3: 
## Chain 3: 
## Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 3: 
## Chain 3:  Elapsed Time: 1.83957 seconds (Warm-up)
## Chain 3:                1.37134 seconds (Sampling)
## Chain 3:                3.21091 seconds (Total)
## Chain 3: 
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 4).
## Chain 4: 
## Chain 4: Gradient evaluation took 9.6e-05 seconds
## Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.96 seconds.
## Chain 4: Adjust your expectations accordingly!
## Chain 4: 
## Chain 4: 
## Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 4: 
## Chain 4:  Elapsed Time: 1.81981 seconds (Warm-up)
## Chain 4:                1.61138 seconds (Sampling)
## Chain 4:                3.43119 seconds (Total)
## Chain 4:</code></pre>
<p>Note that <code>prior_only = TRUE</code> will prevent <code>stan_glm</code> from considering the outcome, <code><a href="https://rdrr.io/r/base/Log.html">log(rate.male)</a></code>; for the sake of convenience and simplicity, the entire ME model for covariates is treated as part of the “prior” by <code>prior_only</code>, though this is certainly an abuse of terms.</p>
</div>
<div id="evaluating-spatial-me-models" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluating-spatial-me-models" class="anchor"></a>Evaluating spatial ME models</h2>
<div id="me-diagonstic-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#me-diagonstic-plots" class="anchor"></a>ME diagonstic plots</h3>
<p><strong>geostan</strong> provides a set of diagnostics for its ME models, accessible through the <code>me_diag</code> function. The purpose of the diagnostics is partly to evaluate the quality of the data, and partly to interrogate the adequacy of the model.</p>
<p>As stated previously, sampling error does not contain systematic spatial patterns. So it is important to look at spatial autocorrelation in the probability distribution for <span class="math inline">\(\delta_i\)</span>. We also would like to know how much uncertainty the model assigns to each of the <span class="math inline">\(x_i\)</span> values. We just have to provide <code>me_diag</code> with the fitted model, the name of the variable, and the underlying spatial object:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># style = "B" uses binary matrix for the Moran plot</span>
<span class="co"># (math symbols in figure labels may not be visible on html versions of this vignette)</span>
<span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span>, style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The point-interval plot on the left hand side of the panel shows the ACS estimates on the horizontal axis against a summary of the posterior distribution on the vertical axis. This provides an indication of 1) the amount of uncertainty present in each <span class="math inline">\(x_i\)</span>, and 2) the degree to which the mean of the posterior probability distribution for <span class="math inline">\(x_i\)</span> may differ from the raw survey estimates (<span class="math inline">\(\delta_i\)</span>).</p>
<p>Because we have a joint probability distribution for <span class="math inline">\(\delta_i\)</span>, we also have a probability distribution for any function of <span class="math inline">\(\delta_i\)</span>. To examine spatial autocorrelation, we calculate the Moran coefficient (MC, an index of spatial autocorrelation) for each sample from the posterior distribution of <span class="math inline">\(\delta_i\)</span>. The middle panel is a histogram of those MC values, with the mean of the samples printed at the top. The final panel is a map of the posterior mean for each <span class="math inline">\(\delta_i\)</span> value.</p>
<p>From the point-interval plot, we can see that a few of the counties with low ICE estimates have posterior distributions that have shifted slightly towards the mean. However, notice that the model still places substantial probability on values of the ICE that are <em>more</em> extreme than the raw ACS estimates. The MC histogram is centered on zero; that’s acceptable but, ideally, this should be centered on a small negative value, indicating balanced spatial smoothing.</p>
<p>Large <span class="math inline">\(|\delta_i|\)</span> values can provide a warning that your data may be of low quality; strong social or spatial patterns in <span class="math inline">\(\delta_i\)</span>, on the other hand, should prompt you to ask further questions about the adequacy of the model.</p>
</div>
<div id="looking-closer" class="section level3">
<h3 class="hasAnchor">
<a href="#looking-closer" class="anchor"></a>Looking closer</h3>
<p>To look more closely at the model results, we can have <code>me_diag</code> return the index value for the observations with the <span class="math inline">\(k\)</span> largest <span class="math inline">\(\delta_i\)</span> values:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span>, style <span class="op">=</span> <span class="st">"B"</span>, index <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<pre><code>## Identifying the top 5 observations as ordered by their Delta values (Delta = posterior mean of x - raw x value):</code></pre>
<pre><code>##                 x.raw       x.mu      x.lwr      x.upr       Delta
## x_ICE[105] -0.3412494 -0.3072684 -0.3844675 -0.2280845 -0.03398098
## x_ICE[91]  -0.4016787 -0.3684549 -0.4557586 -0.2808782 -0.03322371
## x_ICE[90]  -0.2798395 -0.2551308 -0.3255598 -0.1856526 -0.02470868
## x_ICE[39]  -0.3236583 -0.2996782 -0.3782048 -0.2223879 -0.02398012
## x_ICE[18]   0.2446345  0.2262050  0.1889285  0.2632106  0.01842952</code></pre>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Or, we can have <code>me_diag</code> return results as raw data (it will also return a list of <code>ggplots</code>):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">delta_data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span></code></pre></div>
<pre><code>##                x.raw        x.mu       x.lwr        x.upr         Delta
## x_ICE[1] -0.24576780 -0.23648118 -0.28668474 -0.185738090 -9.286619e-03
## x_ICE[2] -0.27540984 -0.26713843 -0.32041068 -0.212685764 -8.271402e-03
## x_ICE[3] -0.01856313 -0.01809602 -0.03334670 -0.002406031 -4.671144e-04
## x_ICE[4]  0.05059098  0.05053513  0.04292626  0.058488128  5.585485e-05
## x_ICE[5]  0.14701110  0.14430757  0.12468271  0.164891720  2.703533e-03
## x_ICE[6]  0.16649112  0.16625646  0.15775887  0.174877525  2.346591e-04</code></pre>
<p>Lets scale these by the MAD of the ICE:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scaled_delta</span> <span class="op">&lt;-</span> <span class="va">delta</span><span class="op">$</span><span class="va">Delta</span> <span class="op">/</span> <span class="va">mad.ice</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">scaled_delta</span><span class="op">)</span>,
                 col <span class="op">=</span> <span class="st">'gray50'</span>,
                 binwidth <span class="op">=</span> <span class="fl">0.05</span>
                 <span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-14-1.png" width="336" style="display: block; margin: auto;"></p>
<p>Most are minuscule, but a few are not. We can follow up on this information by examining demographic information on the counties with the largest <span class="math inline">\(\delta_i\)</span>:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">georgia</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">91</span>, <span class="fl">105</span>, <span class="fl">90</span>, <span class="fl">39</span>, <span class="fl">143</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NAME"</span>, <span class="st">"population"</span>, <span class="st">"white"</span>, <span class="st">"black"</span>, <span class="st">"hisp"</span>, <span class="st">"ai"</span>, <span class="st">"ICE"</span>, <span class="st">"ICE.se"</span>, <span class="st">"college"</span>, <span class="st">"college.se"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>## Simple feature collection with 5 features and 10 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -85.06359 ymin: 30.58092 xmax: -82.41898 ymax: 33.46918
## Geodetic CRS:  NAD83
##        NAME population    white    black       hisp         ai        ICE
## 91   Clinch       6743 65.35667 27.61382  5.1164170 0.05932078 -0.4016787
## 105 Wheeler       7939 56.06500 42.10858  1.2722005 0.45345761 -0.3412494
## 90  Hancock       8535 24.22964 72.29057  1.9214997 0.00000000 -0.2798395
## 39  Stewart       6042 24.62761 54.10460 17.2128434 0.14895730 -0.3236583
## 143  Twiggs       8284 55.10623 42.37084  0.4828585 0.00000000 -0.2395249
##         ICE.se college college.se                       geometry
## 91  0.04806692    11.1   2.127660 MULTIPOLYGON (((-82.97125 3...
## 105 0.04801373    12.8   2.492401 MULTIPOLYGON (((-82.92786 3...
## 90  0.04151013     8.8   1.641337 MULTIPOLYGON (((-83.25346 3...
## 39  0.04715834    11.2   1.945289 MULTIPOLYGON (((-85.05141 3...
## 143 0.04010343     9.4   1.398176 MULTIPOLYGON (((-83.59766 3...</code></pre>
<p>We can see that these are low population areas that also have low income, few college grads, and fairly high percent Black populations; crucially, they have large standard errors on their ICE estimates. The somewhat large <span class="math inline">\(\delta_i\)</span> values for these counties are a result of the combination of fairly unreliable estimates (large standard errors) while also being local outliers. Notice that the ACS estimate for the ICE in Clinch County is <span class="math inline">\(-0.40\)</span> (SE = 0.048), implying a 95% margin of error ranging from -0.5 to -0.3 (quite a wide range). Here is our probability distribution for the ICE in Clinch County:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"x_ICE[91]"</span><span class="op">)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-16-1.png" width="336" style="display: block; margin: auto;"></p>
</div>
<div id="non-spatial-me-models" class="section level3">
<h3 class="hasAnchor">
<a href="#non-spatial-me-models" class="anchor"></a>Non-spatial ME models</h3>
<p>If the <code>ME</code> list doesn’t have a slot with <code>car_parts</code>, <strong>geostan</strong> will automatically use a non-spatial Student’s t model instead of the CAR model. We can see how this results in more obviously patterned <span class="math inline">\(\hat{\delta_i}\)</span>:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME</span><span class="op">$</span><span class="va">car_parts</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
 <span class="co"># refresh = 0 stops Stan from printing MCMC status updates</span>
<span class="va">fit_nsp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span> <span class="op">~</span> <span class="va">ICE</span>, data <span class="op">=</span> <span class="va">georgia</span>, ME <span class="op">=</span> <span class="va">ME</span>, prior_only <span class="op">=</span> <span class="cn">TRUE</span>, refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<pre><code>## ----
## *Setting prior parameters for measurement error models</code></pre>
<pre><code>## ----</code></pre>
<pre><code>## 
## *Setting prior parameters for intercept</code></pre>
<pre><code>## Gaussian</code></pre>
<pre><code>##  location     scale 
## -4.169701  5.000000</code></pre>
<pre><code>## 
## *Setting prior parameters for beta
## Gaussian</code></pre>
<pre><code>##     Location Scale
## ICE        0     5</code></pre>
<pre><code>## 
## *Setting prior parameters for sigma</code></pre>
<pre><code>## Student's t</code></pre>
<pre><code>##       df location    scale 
##       10        0        3</code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit_nsp</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div id="working-with-mcmc-samples-from-me-models" class="section level3">
<h3 class="hasAnchor">
<a href="#working-with-mcmc-samples-from-me-models" class="anchor"></a>Working with MCMC samples from ME models</h3>
<p><strong>geostan</strong> consists of pre-compiled Stan models, and users can always access the Markov chain Monte Carlo (MCMC) samples returned by Stan. When extracted as a matrix of samples (as below), each row represents a draw from the joint probability distribution for all model parameters, and each column consists of samples from the marginal distribution of each parameter.</p>
<p>The ME models return samples for every <span class="math inline">\(x_i\)</span> as well as the model parameters <span class="math inline">\(\mu\)</span> (“mu_x_true”), <span class="math inline">\(\rho\)</span> (“car_rho_x_true”), and <span class="math inline">\(\tau\)</span> (“sigma_x_true”). We can access these using <code>as.matrix</code> (or <code>as.array</code> or <code>as.data.frame</code>).</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mu.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"mu_x_true"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">mu.x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 4000    1</code></pre>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mu.x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] -0.1280951</code></pre>
<p>We can visualize these using <code>plot</code>:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mu_x_true"</span>, <span class="st">"car_rho_x_true"</span>, <span class="st">"sigma_x_true"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;"></p>
<p>To extract samples from the joint probability distribution for <span class="math inline">\(\boldsymbol x\)</span>, use the generic parameter name “x_true”:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"x_true"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 4000  159</code></pre>
<p>If we wanted to calculate the mean of each of these marginal distributions, we could use <code>apply</code> with <code>MARGIN = 2</code> to summarize by column:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x.mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x.mu</span><span class="op">)</span></code></pre></div>
<pre><code>##    x_ICE[1]    x_ICE[2]    x_ICE[3]    x_ICE[4]    x_ICE[5]    x_ICE[6] 
## -0.23648118 -0.26713843 -0.01809602  0.05053513  0.14430757  0.16625646</code></pre>
<p>With a matrix of samples, we can also ask questions of the joint probability distribution by applying summary functions to each row (as each row of the matrix of samples is a draw from the joint distribution of parameters), which results in a vector of samples. Those samples can be summarized again (e.g., by their mean) or visualized. Here is the probability distribution for the amount of spatial autocorrelation in <span class="math inline">\(\boldsymbol x\)</span>, the true ICE values, as indexed by the Moran coefficient:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="va">mc</span>, w <span class="op">=</span> <span class="va">C</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x.mc</span><span class="op">)</span>,
                 col <span class="op">=</span> <span class="st">'gray50'</span>,
                 binwidth <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-22-1.png" width="336" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="incorporating-me-models-into-larger-spatial-models" class="section level2">
<h2 class="hasAnchor">
<a href="#incorporating-me-models-into-larger-spatial-models" class="anchor"></a>Incorporating ME models into larger spatial models</h2>
<p>Incorporating these ME models into any other <strong>geostan</strong> model is as simple as removing the <code>prior_only</code> argument (or setting it to <code>FALSE</code>), as here:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span> <span class="op">~</span> <span class="va">ICE</span>, data <span class="op">=</span> <span class="va">georgia</span>, ME <span class="op">=</span> <span class="va">ME</span><span class="op">)</span></code></pre></div>
<p>The ME model will automatically be added to the Bayesian regression analysis, so that the parameters are all modeled jointly with the covariate. This means that our observational uncertainty will be propagated throughout the model.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-chun_2013">
<p>Chun, Yongwan, and Daniel A Griffith. 2013. <em>Spatial Statistics and Geostatistics: Theory and Applications for Geographic Information Science and Technology</em>. Sage.</p>
</div>
<div id="ref-donegan_2021">
<p>Donegan, Connor, Yongwan Chun, and Daniel A Griffith. 2021. “Modeling Community Health with Areal Data: Bayesian Inference with Survey Standard Errors and Spatial Structure.” <em>International Journal of Environmental Research and Public Health</em> 18 (13): 6856. <a href="https://doi.org/10.3390/ijerph18136856">https://doi.org/10.3390/ijerph18136856</a>.</p>
</div>
<div id="ref-massey_2001">
<p>Massey, Douglas. 2001. “The Prodigal Paradigm Returns: Ecology Comes Back to Sociology.” In <em>Does It Take a Village? Community Effects on Children, Adolescents, and Families</em>, edited by Alan Booth and Ann Crouter, 41–48. Lawrence Erlbaum Associates.</p>
</div>
<div id="ref-census_2019">
<p>United States Census Bureau. 2019. <em>2015–2019 Variance Replicate Tables Documentation</em>. Suitland, MD, USA: U.S. Department of Commerce, Bureau of the Census <a href="https://www.census.gov/programs-surveys/acs/data/variance-tables.html">https://www.census.gov/programs-surveys/acs/data/variance-tables.html</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>By definition, any systematic pattern in the errors, <span class="math inline">\(\delta_i\)</span>, is not due to sampling error—it is bias, necessarily in addition to sampling error (and spatial patterns that arise by chance are already accounted for in the probability model for sampling error). Bias is a far more difficult inferential problem, and to model it would require more information than we have. Hence, we take for granted the structural validity of the survey design for present purposes (i.e., we proceed as if we believed the bias were zero).<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
