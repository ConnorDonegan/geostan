<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with American Community Survey data • geostan</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Working with American Community Survey data">
<meta property="og:description" content="geostan">
<meta property="og:image" content="https://connordonegan.github.io/geostan/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116873024-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116873024-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/measuring-sa.html">Measuring and visualizing spatial autocorrelation</a>
    </li>
    <li>
      <a href="../articles/spatial-me-models.html">Working with American Community Survey data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ConnorDonegan/geostan/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with American Community Survey data</h1>
                        <h4 data-toc-skip class="author">Connor Donegan</h4>
            
            <h4 data-toc-skip class="date">September 13, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/geostan/blob/master/vignettes/spatial-me-models.Rmd" class="external-link"><code>vignettes/spatial-me-models.Rmd</code></a></small>
      <div class="hidden name"><code>spatial-me-models.Rmd</code></div>

    </div>

    
    
<p>This vignette introduces users to the spatial measurement error (ME) models implemented in the <strong>geostan</strong> package <span class="citation">(Donegan, Chun, and Griffith <a href="#ref-donegan_2021">2021</a>; Donegan <a href="#ref-donegan_2021b">2021</a>)</span>. These models are particularly appropriate for working with American Community Survey (ACS) data and other large, government-backed surveys.</p>
<p>A premise of this methodology is that the survey includes a systematic spatial sampling design (i.e., the sampling procedure was stratified by areal unit, whether they be block groups, counties, or states).</p>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor" aria-hidden="true"></a>Getting started</h2>
<p>From the R console, load the <strong>geostan</strong> and <strong>ggplot2</strong> packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://connordonegan.github.io/geostan/">geostan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">)</span></code></pre></div>
<p>The line <code>data(georgia)</code> loads the <code>georgia</code> data set from the <strong>geostan</strong> package into your working environment. You can learn more about the data by entering <code><a href="../reference/georgia.html">?georgia</a></code> to the R console.</p>
</div>
<div id="ice-data" class="section level2">
<h2 class="hasAnchor">
<a href="#ice-data" class="anchor" aria-hidden="true"></a>ICE data</h2>
<p>This vignette will make use of the index of concentration at the extremes (ICE) <span class="citation">(Massey <a href="#ref-massey_2001">2001</a>)</span>. The ICE is the difference between the proportion of the population residing in a high income households and the proportion in low income households: <span class="math display">\[\text{ICE} = \text{Proportion Rich} - \text{Proportion Poor,}\]</span> where “rich” and “poor” are defined as the top and bottom quintiles of the US household income distribution (<span class="math inline">\(&lt; \$20,000\)</span> and <span class="math inline">\(&gt;= \$120,000\)</span>), respectively. It ranges from -1, for an entirely impoverished population, to 1, for an entirely wealthy population.</p>
<p>In this vignette, we will examine the ICE standard errors and build a probability model for the actual ICE values. The purpose of the vignette is to provide a guide to critically evaluating both your data and the ME model.</p>
<p>Examining the standard errors directly is informative, but not quite enlightening<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">$</span><span class="va">ICE.se</span>, <span class="va">georgia</span>, name <span class="op">=</span> <span class="st">"SE(ICE)"</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;"></p>
<p>This shows that there are strong spatial patterns in the reliability of the estimates. For continuous measures like the ICE, it is helpful to scale the standard errors by the scale of the data. Using the median absolute deviation (MAD) is a good option:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sd.ice</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">$</span><span class="va">ICE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.126393</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mad.ice</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html" class="external-link">mad</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">$</span><span class="va">ICE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.09241624</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scaled_se</span> <span class="op">&lt;-</span> <span class="va">georgia</span><span class="op">$</span><span class="va">ICE.se</span> <span class="op">/</span> <span class="va">mad.ice</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">scaled_se</span><span class="op">)</span>,
                 col <span class="op">=</span> <span class="st">'gray50'</span>,
                binwidth <span class="op">=</span> <span class="fl">0.05</span>
                 <span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-3-1.png" width="336" style="display: block; margin: auto;"></p>
<p>No we can see that a number of these estimates are not particularly reliable.</p>
</div>
<div id="modeling-errors-of-observation" class="section level2">
<h2 class="hasAnchor">
<a href="#modeling-errors-of-observation" class="anchor" aria-hidden="true"></a>Modeling errors of observation</h2>
<p>The unknown errors, <span class="math inline">\(\delta_i\)</span>, are defined as the difference between the survey estimate, <span class="math inline">\(z_i\)</span>, of some variable, and that variable’s actual value over the same time period, <span class="math inline">\(x_i\)</span>: <span class="math display">\[\delta_i = z_i - x_i.\]</span> For present purposes, we will take for granted the high quality of the Census Bureau’s systematic spatial sampling design <span class="citation">(on spatial sampling, see Chun and Griffith <a href="#ref-chun_2013">2013</a>)</span>, and thus, we do not expect there to be any spatial pattern to the errors, <span class="math inline">\(\delta_i\)</span>.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></p>
<p>Using Bayes’ theorem and the information at our disposal, we can create a probability distribution for these errors. Since <span class="math inline">\(\delta_i\)</span> is a simple function of <span class="math inline">\(z_i\)</span> and <span class="math inline">\(x_i\)</span>, we need to reason about <span class="math display">\[p(\boldsymbol x | \boldsymbol z, \mathcal M),\]</span> where <span class="math inline">\(\mathcal M\)</span> represents our relevant background knowledge. <span class="math inline">\(\mathcal M\)</span> includes the standard errors, <span class="math inline">\(\boldsymbol s\)</span>, as well as the premise that this data was collected using a valid spatial sampling design.</p>
<p>By Bayes’ theorem: <span class="math display">\[\begin{equation}
\begin{split} 
  p(\boldsymbol x | \boldsymbol z, \mathcal M) &amp;\propto p(\boldsymbol z | \boldsymbol x, \mathcal M) p(\boldsymbol x | \mathcal M)   \\
   &amp;\propto \text{Likelihood} \times \text{prior}
   \end{split}
\end{equation}\]</span></p>
<p>The ME models implemented in <strong>geostan</strong> are hierarchical Bayesian models (HBMs) that incorporate two sources of information: a sampling distribution for the survey estimates, and generic background knowledge on social variables. The former is a likelihood statement that states: for a given true value, <span class="math inline">\(x_i\)</span>, and standard error, <span class="math inline">\(s_i\)</span>, the probability of obtaining survey estimate <span class="math inline">\(z_i\)</span> is <span class="math display">\[z_i \sim Gauss(x_i, s_i).\]</span> This reflects the statement that sampling error is not systematically patterned, and it is consistent with conventional ‘margins of error’ for survey estimates.</p>
<p>The relevant background knowledge includes our basic understanding of contemporary society, particularly that extreme conditions are not implausible, but tend to be clustered together (with important exceptions)<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. This information is encoded into a probability distribution for the unknown set of values, <span class="math inline">\(\boldsymbol x\)</span>, using the conditional autoregressive (CAR) model: <span class="math display">\[ \boldsymbol x \sim Gauss(\mu \cdot \boldsymbol 1, \Sigma). \]</span> This is a multivariate normal distribution with a constant mean, <span class="math inline">\(\mu\)</span>, and covariance matrix <span class="math display">\[\boldsymbol \Sigma = (I - \rho C)^{-1} M .\]</span> <span class="math inline">\(\Sigma\)</span> contains the spatial connectivity matrix, <span class="math inline">\(\boldsymbol C\)</span>. <span class="math inline">\(M\)</span> is a diagonal matrix that contains the scale parameter, <span class="math inline">\(\tau^2\)</span>, multiplied by given constant terms. There are numerous ways to specify <span class="math inline">\(C\)</span> and <span class="math inline">\(M\)</span> with the CAR model (see <code><a href="../reference/prep_car_data.html">geostan::prep_car_data</a></code>).</p>
<p>The parameters <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\rho\)</span>, and <span class="math inline">\(\tau\)</span> all require prior probability distributions that respect one’s background knowledge on the variable of interest; <strong>geostan</strong> uses the following by default: <span class="math display">\[\begin{equation} 
\begin{split}
\mu &amp;\sim Gauss(0, 100) \\
\tau &amp;\sim Student_t(10, 0, 40) \\
\rho &amp;\sim Uniform(\text{lower_bound}, \text{upper_bound})
\end{split}
\end{equation}\]</span></p>
<p>The default prior for <span class="math inline">\(\rho\)</span> is uniform across its entire support (determined by the extreme eigenvalues of <span class="math inline">\(C\)</span>).</p>
</div>
<div id="me-models-in-geostan" class="section level2">
<h2 class="hasAnchor">
<a href="#me-models-in-geostan" class="anchor" aria-hidden="true"></a>ME models in <strong>geostan</strong>
</h2>
<p>These ME models can be implemented using any of the <strong>geostan</strong> model fitting functions (<code>stan_glm</code>, <code>stan_car</code>, <code>stan_esf</code>, and <code>stan_icar</code>). These functions have a formula interface, so that the basic user experience is similar to using <code>base::glm</code>. For example, if we were to fit a linear model to the log-mortality rates, we could start with the following code:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span> <span class="op">~</span> <span class="va">ICE</span>, data <span class="op">=</span> <span class="va">georgia</span>, prior_only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>For now, we are just going to use <code>stan_glm</code> to set up our ME models. To tell <code>stan_glm</code> to ignore the outcome data and fit the ME model described above, we add <code>prior_only = TRUE</code>.</p>
<p>First, we need to build a list containing data for the ME model. The list must contain an element named <code>se</code>, which must be a data frame with standard errors for all of the estimates. To fit the spatial models introduced above, we also need to provide a list called <code>car_parts</code> with data for the CAR model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># use binary weights matrix for prep_car_data</span>
<span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">georgia</span>, style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>
<span class="va">cp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep_car_data.html">prep_car_data</a></span><span class="op">(</span><span class="va">C</span>, style <span class="op">=</span> <span class="st">"WCAR"</span><span class="op">)</span></code></pre></div>
<pre><code>## Range of permissible rho values:  -1.661134 1</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ICE <span class="op">=</span> <span class="va">georgia</span><span class="op">$</span><span class="va">ICE.se</span><span class="op">)</span>,
  car_parts <span class="op">=</span> <span class="va">cp</span>
<span class="op">)</span></code></pre></div>
<p>The ICE can only range from -1 to 1; to provide the model with this information, we add an element named <code>bounds</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME</span><span class="op">$</span><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>As noted previously, <strong>geostan</strong> will use its default priors if none are provided. The following code demonstrates setting custom priors for <span class="math inline">\(\mu\)</span> (location) and <span class="math inline">\(\tau\)</span> (scale) (see <code><a href="../reference/priors.html">?priors</a></code> for details):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME</span><span class="op">$</span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">normal</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">0</span>, scale <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,
                 scale <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">student_t</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">10</span>, location <span class="op">=</span> <span class="fl">0</span>, scale <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>To sample from our spatial ME model alone, we pass our list of <code>ME</code> data to <code>stan_glm</code> and use <code>prior_only = TRUE</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span> <span class="op">~</span> <span class="va">ICE</span>, data <span class="op">=</span> <span class="va">georgia</span>, ME <span class="op">=</span> <span class="va">ME</span>, prior_only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## *Setting ME model prior
## *Setting prior for CAR spatial autocorrelation parameter (rho)</code></pre>
<pre><code>## Distribution: uniform</code></pre>
<pre><code>##   lower upper
## 1  -1.7     1</code></pre>
<pre><code>## 
## *Setting prior parameters for intercept</code></pre>
<pre><code>## Distribution: normal</code></pre>
<pre><code>##   location scale
## 1     -4.2     5</code></pre>
<pre><code>## 
## *Setting prior parameters for beta
## Distribution: normal</code></pre>
<pre><code>##   location scale
## 1        0     5</code></pre>
<pre><code>## 
## *Setting prior parameters for sigma</code></pre>
<pre><code>## Distribution: student_t</code></pre>
<pre><code>##   df location scale
## 1 10        0     3
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0.000115 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.15 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 1.78941 seconds (Warm-up)
## Chain 1:                1.26922 seconds (Sampling)
## Chain 1:                3.05863 seconds (Total)
## Chain 1: 
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 2).
## Chain 2: 
## Chain 2: Gradient evaluation took 9.6e-05 seconds
## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.96 seconds.
## Chain 2: Adjust your expectations accordingly!
## Chain 2: 
## Chain 2: 
## Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 2: 
## Chain 2:  Elapsed Time: 1.49813 seconds (Warm-up)
## Chain 2:                1.27158 seconds (Sampling)
## Chain 2:                2.76971 seconds (Total)
## Chain 2: 
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 3).
## Chain 3: 
## Chain 3: Gradient evaluation took 0.000156 seconds
## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.56 seconds.
## Chain 3: Adjust your expectations accordingly!
## Chain 3: 
## Chain 3: 
## Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 3: 
## Chain 3:  Elapsed Time: 1.55565 seconds (Warm-up)
## Chain 3:                1.28156 seconds (Sampling)
## Chain 3:                2.83722 seconds (Total)
## Chain 3: 
## 
## SAMPLING FOR MODEL 'foundation' NOW (CHAIN 4).
## Chain 4: 
## Chain 4: Gradient evaluation took 9.5e-05 seconds
## Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.95 seconds.
## Chain 4: Adjust your expectations accordingly!
## Chain 4: 
## Chain 4: 
## Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 4: 
## Chain 4:  Elapsed Time: 5.51256 seconds (Warm-up)
## Chain 4:                1.28811 seconds (Sampling)
## Chain 4:                6.80067 seconds (Total)
## Chain 4:</code></pre>
<p>Note that <code>prior_only = TRUE</code> will prevent <code>stan_glm</code> from considering the likelihood of the outcome, <code>log(rate.male)</code>; to facilitate a valid workflow, the entire ME model is treated as part of the “prior” by <code>prior_only</code>. This allows us to understand the properties of the ME model itself, considered independently from any outcome variable.</p>
</div>
<div id="evaluating-spatial-me-models" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluating-spatial-me-models" class="anchor" aria-hidden="true"></a>Evaluating spatial ME models</h2>
<div id="me-diagnostic-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#me-diagnostic-plots" class="anchor" aria-hidden="true"></a>ME diagnostic plots</h3>
<p><strong>geostan</strong> provides a set of diagnostics for its ME models, accessible through the <code>me_diag</code> function. The purpose of the diagnostics is partly to evaluate the quality of the data, and partly to interrogate the adequacy of the model.</p>
<p>Provide <code>me_diag</code> with the fitted model, the name of the variable, and the underlying spatial object:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># (math symbols in figure labels may not be visible on html versions of this vignette)</span>
<span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;"></p>
<p>We get three plots:</p>
<ul>
<li><p>A point-interval plot showing the ACS estimates on the horizontal axis against a summary of the posterior distribution on the vertical axis. This provides an indication of 1) the amount of uncertainty present in each <span class="math inline">\(x_i\)</span>, and 2) the degree to which the mean of the posterior probability distribution for <span class="math inline">\(x_i\)</span> may differ from the raw survey estimates (<span class="math inline">\(\delta_i\)</span>).</p></li>
<li><p>A histogram of Moran coefficients calculated for each MCMC sample. The mean of the samples is printed at the top. Zero spatial autocorrelation is indicated by a small negative value (unlike the correlation coefficient, the midpoint of the MC is <span class="math inline">\(-1/(n-1)\)</span> <span class="citation">(Chun and Griffith <a href="#ref-chun_2013">2013</a>)</span>).</p></li>
<li><p>A map of the posterior mean for each <span class="math inline">\(\delta_i\)</span> value.</p></li>
</ul>
<p>From the point-interval plot, we can see that a few of the counties with low ICE estimates have posterior distributions that have shifted slightly towards the mean. However, notice that the model still places substantial probability on values of the ICE that are <em>more</em> extreme than the raw ACS estimates.</p>
<p>Large <span class="math inline">\(|\delta_i|\)</span> values can provide a warning that your data may be of low quality; strong social or spatial patterns in <span class="math inline">\(\delta_i\)</span>, on the other hand, should prompt you to ask further questions about the adequacy of the model.</p>
</div>
<div id="looking-closer" class="section level3">
<h3 class="hasAnchor">
<a href="#looking-closer" class="anchor" aria-hidden="true"></a>Looking closer</h3>
<p>To look more closely at the model results, we can have <code>me_diag</code> return the index value for the observations with the <span class="math inline">\(k\)</span> largest <span class="math inline">\(\delta_i\)</span> values:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span>, index <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<pre><code>## Identifying the top 5 observations as ordered by their Delta values (Delta = posterior mean of x - raw x value):</code></pre>
<pre><code>##                 x.raw       x.mu      x.lwr      x.upr       Delta
## x_ICE[105] -0.3412494 -0.3078229 -0.3902836 -0.2269994 -0.03342644
## x_ICE[91]  -0.4016787 -0.3687011 -0.4518861 -0.2855704 -0.03297751
## x_ICE[90]  -0.2798395 -0.2555348 -0.3284296 -0.1818271 -0.02430469
## x_ICE[39]  -0.3236583 -0.3004071 -0.3835770 -0.2163182 -0.02325112
## x_ICE[143] -0.2395249 -0.2215446 -0.2934025 -0.1508020 -0.01798036</code></pre>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Or, we can have <code>me_diag</code> return results as raw data (it will also return a list of <code>ggplots</code>):</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">delta_data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span></code></pre></div>
<pre><code>##                x.raw        x.mu       x.lwr        x.upr         Delta
## x_ICE[1] -0.24576780 -0.23698772 -0.29127882 -0.184354716 -0.0087800805
## x_ICE[2] -0.27540984 -0.26728103 -0.31911550 -0.214743398 -0.0081288041
## x_ICE[3] -0.01856313 -0.01804477 -0.03316604 -0.002945463 -0.0005183682
## x_ICE[4]  0.05059098  0.05053614  0.04309910  0.058017459  0.0000548432
## x_ICE[5]  0.14701110  0.14456699  0.12335775  0.165659789  0.0024441077
## x_ICE[6]  0.16649112  0.16626520  0.15815698  0.174221845  0.0002259138</code></pre>
<p>We can follow up on this information by examining demographic information on the counties with the largest <span class="math inline">\(\delta_i\)</span>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">georgia</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">91</span>, <span class="fl">105</span>, <span class="fl">90</span>, <span class="fl">39</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NAME"</span>, <span class="st">"population"</span>, <span class="st">"white"</span>, <span class="st">"black"</span>, <span class="st">"hisp"</span>, <span class="st">"ai"</span>, <span class="st">"ICE"</span>, <span class="st">"ICE.se"</span>, <span class="st">"college"</span>, <span class="st">"college.se"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>## Simple feature collection with 4 features and 10 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -85.06359 ymin: 30.58092 xmax: -82.41898 ymax: 33.46918
## Geodetic CRS:  NAD83
##        NAME population    white    black      hisp         ai        ICE
## 91   Clinch       6743 65.35667 27.61382  5.116417 0.05932078 -0.4016787
## 105 Wheeler       7939 56.06500 42.10858  1.272201 0.45345761 -0.3412494
## 90  Hancock       8535 24.22964 72.29057  1.921500 0.00000000 -0.2798395
## 39  Stewart       6042 24.62761 54.10460 17.212843 0.14895730 -0.3236583
##         ICE.se college college.se                       geometry
## 91  0.04806692    11.1   2.127660 MULTIPOLYGON (((-82.97125 3...
## 105 0.04801373    12.8   2.492401 MULTIPOLYGON (((-82.92786 3...
## 90  0.04151013     8.8   1.641337 MULTIPOLYGON (((-83.25346 3...
## 39  0.04715834    11.2   1.945289 MULTIPOLYGON (((-85.05141 3...</code></pre>
<p>The somewhat large <span class="math inline">\(\delta_i\)</span> values for these counties are a result of the combination of fairly unreliable estimates (large standard errors) while also being local outliers. But we can see that these are low population areas that also have low income, few college grads, and fairly high percent Black populations; crucially, they have large standard errors on their ICE estimates.</p>
<p>Notice that the ACS estimate for the ICE in Clinch County is <span class="math inline">\(-0.40\)</span> (SE = 0.048), implying a 95% margin of error ranging from -0.5 to -0.3 (quite a wide range). Here is our probability distribution for the ICE in Clinch County:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"x_ICE[91]"</span><span class="op">)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-13-1.png" width="336" style="display: block; margin: auto;"></p>
</div>
<div id="working-with-mcmc-samples-from-me-models" class="section level3">
<h3 class="hasAnchor">
<a href="#working-with-mcmc-samples-from-me-models" class="anchor" aria-hidden="true"></a>Working with MCMC samples from ME models</h3>
<p><strong>geostan</strong> consists of pre-compiled Stan models, and users can always access the Markov chain Monte Carlo (MCMC) samples returned by Stan. When extracted as a matrix of samples (as below), each row represents a draw from the joint probability distribution for all model parameters, and each column consists of samples from the marginal distribution of each parameter.</p>
<p>The ME models return samples for every <span class="math inline">\(x_i\)</span> as well as the model parameters <span class="math inline">\(\mu\)</span> (“mu_x_true”), <span class="math inline">\(\rho\)</span> (“car_rho_x_true”), and <span class="math inline">\(\tau\)</span> (“sigma_x_true”). We can access these using <code>as.matrix</code> (or <code>as.array</code> or <code>as.data.frame</code>).</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mu.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"mu_x_true"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mu.x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 4000    1</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mu.x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] -0.1297073</code></pre>
<p>We can visualize these using <code>plot</code>:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mu_x_true"</span>, <span class="st">"car_rho_x_true"</span>, <span class="st">"sigma_x_true"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;"></p>
<p>To extract samples from the joint probability distribution for <span class="math inline">\(\boldsymbol x\)</span>, use the generic parameter name “x_true”:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"x_true"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 4000  159</code></pre>
<p>If we wanted to calculate the mean of each of these marginal distributions, we could use <code>apply</code> with <code>MARGIN = 2</code> to summarize by column:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x.mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x.mu</span><span class="op">)</span></code></pre></div>
<pre><code>##    x_ICE[1]    x_ICE[2]    x_ICE[3]    x_ICE[4]    x_ICE[5]    x_ICE[6] 
## -0.23698772 -0.26728103 -0.01804477  0.05053614  0.14456699  0.16626520</code></pre>
</div>
</div>
<div id="non-spatial-me-models" class="section level2">
<h2 class="hasAnchor">
<a href="#non-spatial-me-models" class="anchor" aria-hidden="true"></a>Non-spatial ME models</h2>
<p>If the <code>ME</code> list doesn’t have a slot with <code>car_parts</code>, <strong>geostan</strong> will automatically use a non-spatial Student’s t model instead of the CAR model:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ME_nsp</span> <span class="op">&lt;-</span> <span class="va">ME</span>
<span class="va">ME_nsp</span><span class="op">$</span><span class="va">car_parts</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="va">fit_nsp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span> <span class="op">~</span> <span class="va">ICE</span>, data <span class="op">=</span> <span class="va">georgia</span>, ME <span class="op">=</span> <span class="va">ME_nsp</span>, prior_only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="spatial-regression-with-a-noisy-covariate" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-regression-with-a-noisy-covariate" class="anchor" aria-hidden="true"></a>Spatial regression with a noisy covariate</h2>
<p>Incorporating these ME models into any other <strong>geostan</strong> model is as simple as removing the <code>prior_only</code> argument (or setting it to <code>FALSE</code>). The ME model will automatically be incorporated into the Bayesian regression analysis, such that all of the regression parameters are modeled jointly with the ME model. This means that our observational uncertainty for the ICE will be propagated throughout the regression analysis.</p>
<p>At this point, we can introduce a more appropriate model for the mortality data. We will use a Poisson likelihood for the counts of deaths, provide the log-population at risk as an offset term, and pool information across counties using a non-spatial Gaussian model for the log-rates, <span class="math inline">\(\boldsymbol \phi\)</span>: <span class="math display">\[y_i \sim Pois(e^{log(P_i) + \phi_i}) \\ \boldsymbol \phi \sim Gauss(\alpha + \boldsymbol x \beta, I \tau^2),\]</span> where <span class="math inline">\(\alpha\)</span> is the mean log-mortality rate and <span class="math inline">\(\beta\)</span> is the regression coefficient on the modeled ICE, <span class="math inline">\(\boldsymbol x\)</span>. <span class="math inline">\(\tau^2\)</span> is the variance of the log-mortality rates around the fitted regression line, <span class="math inline">\(\alpha + X\beta\)</span>. This model for <span class="math inline">\(\boldsymbol \phi\)</span> is equivalent to a CAR model with <span class="math inline">\(\rho=0\)</span> and <span class="math inline">\(M=I\tau^2\)</span>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">deaths.male</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">pop.at.risk.male</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">ICE</span>, 
                  re <span class="op">=</span> <span class="op">~</span> <span class="va">NAME</span>,   
                  data <span class="op">=</span> <span class="va">georgia</span>, 
                  ME <span class="op">=</span> <span class="va">ME</span>, 
                  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>, 
                  refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## *Setting ME model prior
## *Setting prior for CAR spatial autocorrelation parameter (rho)</code></pre>
<pre><code>## Distribution: uniform</code></pre>
<pre><code>##   lower upper
## 1  -1.7     1</code></pre>
<pre><code>## 
## *Setting prior parameters for intercept</code></pre>
<pre><code>## Distribution: normal</code></pre>
<pre><code>##   location scale
## 1     -4.2     5</code></pre>
<pre><code>## 
## *Setting prior parameters for beta
## Distribution: normal</code></pre>
<pre><code>##   location scale
## 1        0     5</code></pre>
<pre><code>## 
## *Setting prior parameters for alpha_tau</code></pre>
<pre><code>## Distribution: student_t</code></pre>
<pre><code>##   df location scale
## 1 10        0     3</code></pre>
<p>Printing the model results will show the model specification, the mean Moran coefficient of the residuals, a summary of the posterior distributions of select model parameters, and some MCMC diagnostics from Stan.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_2</span><span class="op">)</span></code></pre></div>
<pre><code>## Spatial Model Results 
## Formula: deaths.male ~ offset(log(pop.at.risk.male)) + ICE
## Partial pooling (varying intercept): ~NAME
## 
## Spatial method (outcome):  Exchangeable 
## Likelihood function:  poisson 
## Link function:  log 
## Residual Moran Coefficient:  0.03585625 
## WAIC:  1317.73 
## Observations:  159 
## Data models (ME): ICE
##  Data model (ME prior): CAR (auto Gaussian)
## Inference for Stan model: foundation.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##             mean se_mean    sd   2.5%    25%    50%    75%  97.5% n_eff  Rhat
## intercept -4.385   0.001 0.017 -4.417 -4.396 -4.385 -4.374 -4.351   771 1.011
## ICE       -1.716   0.003 0.100 -1.904 -1.787 -1.718 -1.648 -1.518   834 1.009
## alpha_tau  0.123   0.000 0.011  0.102  0.115  0.123  0.130  0.147  1616 1.000
## 
## Samples were drawn using NUTS(diag_e) at Thu Sep 30 14:50:46 2021.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
<div id="joint-probabilities" class="section level2">
<h2 class="hasAnchor">
<a href="#joint-probabilities" class="anchor" aria-hidden="true"></a>Joint probabilities</h2>
<p>As stated above, our model is a joint probability distribution for all of the unknown parameters. This means that the probability distribution for <span class="math inline">\(\boldsymbol x\)</span> that we obtained previously will be updated in consideration of the new information (that is, considering the the regression model and the outcome data).</p>
<p>In the case of our example model, the bivariate regression relationship implies a multivariate normal probability model for <span class="math inline">\(\boldsymbol x\)</span> and <span class="math inline">\(\boldsymbol \phi\)</span> with correlation <span class="math inline">\(\rho_{x \phi}\)</span>.</p>
<p>An important implication of this fact is that the previously stated criteria for evaluating ME models (e.g., regarding spatial autocorrelation) no longer apply, because the results presented here (<code>fit_2</code>) are conditioned on quite different information, not just the survey data. This is why it is important to critically evaluate the ME model itself, with <code>prior_only = TRUE</code>, before moving to a subsequent stage of analysis.</p>
<p>To make this more concrete, consider the various outliers in this scatter plot of ICE estimates against crude log-mortality rates:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ICE</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rate.male</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">ICE.se</span><span class="op">)</span>,
             shape <span class="op">=</span> <span class="fl">6</span>,
             lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
<span class="co"># geom_label(label = row.names(georgia), aes(ICE, log(rate.male), col = ICE.se)) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"ICE Estimate"</span>, y <span class="op">=</span> <span class="st">"Crude log mortality"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"darkred"</span>, name <span class="op">=</span> <span class="st">"SE(ICE)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'gray20'</span><span class="op">)</span>,
        plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'gray80'</span><span class="op">)</span>,
        legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'gray80'</span><span class="op">)</span>
        <span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-21-1.png" width="432" style="display: block; margin: auto;"></p>
<p>Two counties in particular (Wheeler and Echols) stand out for having low ICE estimates, large standard errors on their ICE estimates, and mortality rates that resemble areas with considerably higher ICE values.</p>
<p>Now let’s see how the posterior distribution of <span class="math inline">\(\boldsymbol x\)</span> has shifted in light of the regression relationship:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/me_diag.html">me_diag</a></span><span class="op">(</span><span class="va">fit_2</span>, <span class="st">'ICE'</span>, <span class="va">georgia</span><span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-22-1.png" width="720" style="display: block; margin: auto;"></p>
<p>While generally similar, one of the biggest shifts from the prior-only model is Wheeler County, a noted outlier, which now has a <span class="math inline">\(\hat{\delta}_i\)</span> value -0.07—twice its value in the prior-only model.</p>
<p>Now here are the posterior means for the ICE and log-mortality rates; the darker red color indicates a higher degree of posterior uncertainty in the ICE value:</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit_2</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">fit_2</span>, pars <span class="op">=</span> <span class="st">"x_true"</span><span class="op">)</span>
<span class="va">x.mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
<span class="va">x.sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">georgia</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x.mean</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">eta</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">x.sd</span><span class="op">)</span>,
             shape <span class="op">=</span> <span class="fl">6</span>,
             lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"ICE"</span>, y <span class="op">=</span> <span class="st">"Log mortality"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"darkred"</span>, name <span class="op">=</span> <span class="st">"SD(ICE)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'gray20'</span><span class="op">)</span>,
        plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'gray80'</span><span class="op">)</span>,
        legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'gray80'</span><span class="op">)</span>
        <span class="op">)</span></code></pre></div>
<p><img src="spatial-me-models_files/figure-html/unnamed-chunk-23-1.png" width="432" style="display: block; margin: auto;"></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor" aria-hidden="true"></a>References</h2>
<div id="refs" class="references">
<div id="ref-chun_2013">
<p>Chun, Yongwan, and Daniel A Griffith. 2013. <em>Spatial Statistics and Geostatistics: Theory and Applications for Geographic Information Science and Technology</em>. Sage.</p>
</div>
<div id="ref-donegan_2021b">
<p>Donegan, Connor. 2021. “Spatial Conditional Autoregressive Models in Stan.” <em>OSF Preprints</em>. <a href="https://doi.org/10.31219/osf.io/3ey65" class="external-link">https://doi.org/10.31219/osf.io/3ey65</a>.</p>
</div>
<div id="ref-donegan_2021">
<p>Donegan, Connor, Yongwan Chun, and Daniel A Griffith. 2021. “Modeling Community Health with Areal Data: Bayesian Inference with Survey Standard Errors and Spatial Structure.” <em>International Journal of Environmental Research and Public Health</em> 18 (13): 6856. <a href="https://doi.org/10.3390/ijerph18136856" class="external-link">https://doi.org/10.3390/ijerph18136856</a>.</p>
</div>
<div id="ref-massey_2001">
<p>Massey, Douglas. 2001. “The Prodigal Paradigm Returns: Ecology Comes Back to Sociology.” In <em>Does It Take a Village? Community Effects on Children, Adolescents, and Families</em>, edited by Alan Booth and Ann Crouter, 41–48. Lawrence Erlbaum Associates.</p>
</div>
<div id="ref-census_2019">
<p>United States Census Bureau. 2019. <em>2015–2019 Variance Replicate Tables Documentation</em>. Suitland, MD, USA: U.S. Department of Commerce, Bureau of the Census <a href="https://www.census.gov/programs-surveys/acs/data/variance-tables.html" class="external-link">https://www.census.gov/programs-surveys/acs/data/variance-tables.html</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Since the ICE is a composite variable, its standard errors were created using the Census Bureau’s variance replicate tables <span class="citation">(United States Census Bureau <a href="#ref-census_2019">2019</a>)</span>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>By definition, any systematic spatial pattern in the errors, <span class="math inline">\(\delta_i\)</span>, is not due to sampling error—it is bias (and spatial patterns that arise by chance are already accounted for in the probability model for sampling error). To model bias would require more information than we have; these models take for granted the structural validity of the survey design (i.e., we proceed as if we believed the bias were zero).<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>The critical analysis of ME models facilitated by <code>me_diag</code> is intended to help identify such situations.<a href="#fnref3" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
