<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Spatial filtering — stan_esf • geostan</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Spatial filtering — stan_esf" />
<meta property="og:description" content="Fit a spatial regression model using eigenvector spatial filtering (ESF)." />
<meta property="og:image" content="https://connordonegan.github.io/geostan/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116873024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116873024-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/ConnorDonegan/geostan/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Spatial filtering</h1>
    <small class="dont-index">Source: <a href='https://github.com/ConnorDonegan/geostan/blob/master/R/stan_esf.R'><code>R/stan_esf.R</code></a></small>
    <div class="hidden name"><code>stan_esf.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Fit a spatial regression model using eigenvector spatial filtering (ESF).</p>
    </div>

    <pre class="usage"><span class='fu'>stan_esf</span><span class='op'>(</span>
  <span class='va'>formula</span>,
  <span class='va'>slx</span>,
  <span class='va'>re</span>,
  <span class='va'>data</span>,
  <span class='va'>C</span>,
  <span class='va'>EV</span>,
  ME <span class='op'>=</span> <span class='cn'>NULL</span>,
  nsa <span class='op'>=</span> <span class='cn'>FALSE</span>,
  threshold <span class='op'>=</span> <span class='fl'>0.25</span>,
  family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span>,
  <span class='va'>p0</span>,
  prior <span class='op'>=</span> <span class='cn'>NULL</span>,
  centerx <span class='op'>=</span> <span class='cn'>FALSE</span>,
  scalex <span class='op'>=</span> <span class='cn'>FALSE</span>,
  prior_only <span class='op'>=</span> <span class='cn'>FALSE</span>,
  chains <span class='op'>=</span> <span class='fl'>4</span>,
  iter <span class='op'>=</span> <span class='fl'>2000</span>,
  refresh <span class='op'>=</span> <span class='fl'>500</span>,
  pars <span class='op'>=</span> <span class='cn'>NULL</span>,
  control <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>adapt_delta <span class='op'>=</span> <span class='fl'>0.99</span>, max_treedepth <span class='op'>=</span> <span class='fl'>15</span><span class='op'>)</span>,
  silent <span class='op'>=</span> <span class='cn'>FALSE</span>,
  <span class='va'>...</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>formula</th>
      <td><p>A model formula, following the R <a href='https://rdrr.io/r/stats/formula.html'>formula</a> syntax. Binomial models are specified by setting the left hand side of the equation to a data frame of successes and failures, as in <code>cbind(successes, failures) ~ x</code>.</p></td>
    </tr>
    <tr>
      <th>slx</th>
      <td><p>Formula to specify any spatially-lagged covariates. As in, <code>slx = ~ x1 + x2</code> (the implicit intercept term in this formula is removed internally).
These will be pre-multiplied by a row-standardized spatial weights matrix and then added (prepended) to the design matrix.
If and when setting priors for <code>beta</code> manually, remember to include priors for any SLX terms as well.</p></td>
    </tr>
    <tr>
      <th>re</th>
      <td><p>If the model includes a varying intercept specify the grouping variable here using formula syntax, as in <code>~ ID</code>. The resulting random effects parameter returned is named <code>alpha_re</code>. The scale parameter for this term is named <code>alpha_tau</code>. That is, <code>alpha_re ~ N(0, alpha_tau)</code>, <code>alpha_tau ~ Student_t(d.f., location, scale)</code>.</p></td>
    </tr>
    <tr>
      <th>data</th>
      <td><p>A <code>data.frame</code> or an object coercible to a data frame by <code>as.data.frame</code> containing the model data.</p></td>
    </tr>
    <tr>
      <th>C</th>
      <td><p>Spatial connectivity matrix which will be used to calculate eigenvectors, residual spatial autocorrelation as well as any user specified <code>slx</code> terms or spatial measurement error (ME) models; it will be row-standardized before calculating <code>slx</code> terms.</p></td>
    </tr>
    <tr>
      <th>EV</th>
      <td><p>A matrix of eigenvectors from any (transformed) connectivity matrix, presumably spatial. If provided, still also provide a spatial weights matrix <code>C</code> for other purposes.  See <a href='make_EV.html'>make_EV</a> and <a href='shape2mat.html'>shape2mat</a>.</p></td>
    </tr>
    <tr>
      <th>ME</th>
      <td><p>To model observational uncertainty (i.e. measurement or sampling error) in any or all of the covariates, provide a named list. Errors are assigned a Gaussian probability distribution and the modeled (true) covariate vector is assigned a Student's t model or, if <code>ME$spatial = TRUE</code>, an auto Gaussian (CAR) model. Elements of the list <code>ME</code> may include:</p><dl>

<dt>se</dt><dd><p>a dataframe with standard errors for each observation; columns will be matched to the variables by column names. The names should match those from the output of <code><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix(formula, data)</a></code>.</p></dd>
<dt>bounded</dt><dd><p>If any variables in <code>se</code> are bounded within some range (e.g. percentages ranging from zero to one hundred) provide a vector of zeros and ones indicating which columns are bounded. By default the lower bound will be 0 and the upper bound 100, for percentages.</p></dd>
<dt>bounds</dt><dd><p>A numeric vector of length two providing the upper and lower bounds, respectively, of any bounded variables.</p></dd>
<dt>spatial</dt><dd><p>Logical value indicating whether an auto Gaussian (conditional autoregressive (CAR)) model should be used for the covariates (see <a href='stan_car.html'>stan_car</a> for CAR model details). For <code>stan_esf</code>, this defaults to <code>spatial = TRUE</code>. If <code>spatial = TRUE</code> you must provide <code>car_parts</code> (see below).</p></dd>
<dt>car_parts</dt><dd><p>A list of data for the CAR model, as returned by <code><a href='prep_car_data.html'>prep_car_data()</a></code> (be sure to return the matrix <code>C</code>, by using the argument <code>cmat = TRUE</code>). Only required if <code>spatial=TRUE</code>.</p></dd>

</dl></td>
    </tr>
    <tr>
      <th>nsa</th>
      <td><p>Include eigenvectors representing negative spatial autocorrelation? Default <code>nsa = FALSE</code>. Ignored if <code>EV</code> is provided.</p></td>
    </tr>
    <tr>
      <th>threshold</th>
      <td><p>Threshold for eigenvector MC value; eigenvectors with values below threshold will be excluded from the candidate set. Default <code>threshold = 0.25</code>; ignored if <code>EV</code> is provided.</p></td>
    </tr>
    <tr>
      <th>family</th>
      <td><p>The likelihood function for the outcome variable. Current options are <code>family = gaussian()</code>, <code><a href='student_t.html'>student_t()</a></code> and <code><a href='https://rdrr.io/r/stats/family.html'>poisson(link = "log")</a></code>, and <code><a href='https://rdrr.io/r/stats/family.html'>binomial(link = "logit")</a></code>.</p></td>
    </tr>
    <tr>
      <th>p0</th>
      <td><p>Number of eigenvector coefficients expected to be far from zero. If this and <code>prior_rhs</code> are missing, Chun et al.'s (2016) formula will be used to fill this in; see <a href='exp_pars.html'>exp_pars</a>. The value of <code>p0</code> is used to control the prior degree of sparsity in the model.</p></td>
    </tr>
    <tr>
      <th>prior</th>
      <td><p>A named list of parameters for prior distributions. User-defined priors can be assigned to the following parameters:</p><dl>
<dt>intercept</dt><dd><p>The intercept is assigned a Gaussian prior distribution; provide a numeric vector with location and scale parameters; e.g. <code>prior = list(intercept = c(location = 0, scale = 10))</code> to assign a Gaussian prior with mean zero and variance 10^2.</p></dd>

<dt>beta</dt><dd><p>Regression coefficients are assigned Gaussian prior distributions. Provide a <code>data.frame</code> with two columns (location and scale).The order of variables must follow their order of appearance in the model <code>formula</code>; e.g., if the formula is <code>y ~ x1 + x2</code>, then providing `prior = list(beta = data.frame(location = c(0, 0), scale = c(1, 1))) will assign standard normal prior distributions to both coefficients.Note that if you also use <code>slx</code> terms (spatially lagged covariates), then you have to provide priors for them; <code>slx</code> terms <em>precede</em> other terms in the model formula. For example, providing of <code>y ~ x1 + x2</code> with <code>slx = ~ x1 + x2</code> is the same as providing <code>formula = y ~ Wx1 + Wx2 + x1 + x2</code>, where <code>Wx1</code> indicates the spatially lagged covariate.</p></dd>

<dt>sigma</dt><dd><p>The scale parameter for Gaussian and Student's t likelihood models is assigned a half-Student's t prior distribution. Thus, provide values for the degrees of freedom, location, and scale parameters; e.g., <code>prior = list(sigma = c(df = 10, location = 0, scale = 5))</code> for a prior centered on zero with scale of 5 and 10 degrees of freedom. The half-Student's t prior for <code>sigma</code> is constrained to be positive.</p></dd>

<dt>nu</dt><dd><p>The degrees of freedom for the Student's t likelihood model is assigned a gamma prior distribution. The default prior is <code>prior = list(nu = c(alpha = 3, beta = 0.2))</code>.</p></dd>

<dt>tau</dt><dd><p>The scale parameter for random effects, or varying intercepts, terms. This scale parameter, <code>tau</code>, is assigned a half-Student's t prior. To set this, use, e.g., <code>prior = list(tau = c(df = 20, location = 0, scale = 20))</code>.</p></dd>

<dt>rhs</dt><dd><p>This is for controlling the regularized horseshoe (RHS) prior, which is assigned to the eigenvector coefficients. Provide a <em>named</em> vector of length three. The RHS prior has two parts to consider. First is the 'slab' that is used to regularize large coefficient estimates; this is a zero-mean Student's t model, the user provides the degrees of freedom and scale parameters. The second component is the global shrinkage parameter, controlling the degree of shrinkage; provide a value nearer to zero if you wish to make the model more sparse. To allow the spatial filter to account for a greater amount of spatial autocorrelation (i.e., if you find the residuals contain spatial autocorrelation), increase the global scale parameter up to one. E.g., <code>prior = list(rhs = c(slab_df = 15, slab_scale = 5, scale_global = 0.5))</code>.</p></dd>

</dl></td>
    </tr>
    <tr>
      <th>centerx</th>
      <td><p>To center predictors, provide either a logical value (TRUE, FALSE) or numeric-alike vector of length equal to the number of columns of ‘x’, where ‘numeric-alike’ means that ‘as.numeric(.)’ will be applied successfully if ‘is.numeric(.)’ is not true. Passed to <code><a href='https://rdrr.io/r/base/scale.html'>scale</a></code>.</p></td>
    </tr>
    <tr>
      <th>scalex</th>
      <td><p>To scale predictors, provide either a logical value or a numeric-alike vector of length equal to the number of columns of ‘x’. Passed to <code><a href='https://rdrr.io/r/base/scale.html'>scale</a></code>.</p></td>
    </tr>
    <tr>
      <th>prior_only</th>
      <td><p>Draw samples from the prior distributions of parameters only.</p></td>
    </tr>
    <tr>
      <th>chains</th>
      <td><p>Number of MCMC chains to estimate. Default <code>chains = 4</code>.</p></td>
    </tr>
    <tr>
      <th>iter</th>
      <td><p>Number of samples per chain. Default <code>iter = 2000</code>.</p></td>
    </tr>
    <tr>
      <th>refresh</th>
      <td><p>Stan will print the progress of the sampler every <code>refresh</code> number of samples. Defaults to <code>500</code>; set <code>refresh=0</code> to silence this.</p></td>
    </tr>
    <tr>
      <th>pars</th>
      <td><p>Optional; specify any additional parameters you'd like stored from the Stan model. Parameters from the RHS priors include <code>tau</code> (the global shrinkage parameter) and <code>lambda</code> (the local shrinkage parameter).</p></td>
    </tr>
    <tr>
      <th>control</th>
      <td><p>A named list of parameters to control the sampler's behavior. See <a href='https://mc-stan.org/rstan/reference/stan.html'>stan</a> for details. The defaults are the same <code><a href='https://mc-stan.org/rstan/reference/stan.html'>rstan::stan</a></code> except that <code>adapt_delta</code> is raised to <code>.99</code> and <code>max_treedepth = 15</code>.</p></td>
    </tr>
    <tr>
      <th>silent</th>
      <td><p>If <code>TRUE</code>, suppress printed messages including prior specifications and Stan sampling progress (i.e. <code>refresh=0</code>). Stan's error and warning messages will still print.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Other arguments passed to <a href='https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html'>sampling</a>.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="source"><a class="anchor" href="#source"></a>Source</h2>

    <p>Chun, Y., D. A. Griffith, M. Lee and P. Sinha (2016). Eigenvector selection with stepwise regression techniques to construct eigenvector spatial filters. <em>Journal of Geographical Systems</em>, 18(1), 67-85. <a href='10.1007/s10109-015-0225-3'>10.1007/s10109-015-0225-3</a></p>
<p>Dray, S., P. Legendre &amp; P. R. Peres-Neto (2006). Spatial modelling: a comprehensive framework for principal coordinate analysis of neighbour matrices (PCNM). <em>Ecological Modeling</em>, 196(3-4), 483-493.</p>
<p>Donegan, C., Y. Chun and A. E. Hughes (2020). Bayesian Estimation of Spatial Filters with Moran’s Eigenvectors and Hierarchical Shrinkage Priors. <em>Spatial Statistics</em> 38. <a href='doi.org/10.1016/j.spasta.2020.100450'>doi.org/10.1016/j.spasta.2020.100450</a></p>
<p>Griffith, Daniel A., and P. R. Peres-Neto (2006). Spatial modeling in ecology: the flexibility of eigenfunction spatial analyses. <em>Ecology</em> 87(10), 2603-2613.</p>
<p>Griffith, D., and Y. Chun (2014). Spatial autocorrelation and spatial filtering, Handbook of Regional Science. Fischer, MM and Nijkamp, P. eds.</p>
<p>Griffith, D., Chun, Y. and Li, B. (2019). <em>Spatial Regression Analysis Using Eigenvector Spatial Filtering</em>. Elsevier.</p>
<p>Piironen, J and A. Vehtari (2017). Sparsity information and regularization in the horseshoe and other shrinkage priors. In <em>Electronic Journal of Statistics</em>, 11(2):5018-5051. <a href='https://projecteuclid.org/euclid.ejs/1513306866'>https://projecteuclid.org/euclid.ejs/1513306866</a></p>
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>An object of class class <code>geostan_fit</code> (a list) containing:</p><dl>
<dt>summary</dt><dd><p>Summaries of the main parameters of interest; a data frame</p></dd>
<dt>diagnostic</dt><dd><p>Widely Applicable Information Criteria (WAIC) with crude measure of effective number of parameters (<code>eff_pars</code>) and
mean log pointwise predictive density (<code>lpd</code>), and residual spatial autocorrelation (Moran coefficient of the residuals). Residuals are relative to the mean posterior fitted values.</p></dd>
<dt>data</dt><dd><p>a data frame containing the model data</p></dd>
<dt>EV</dt><dd><p>A matrix of eigenvectors created with <code>w</code> and <code><a href='make_EV.html'>geostan::make_EV</a></code></p></dd>
<dt>C</dt><dd><p>The spatial weights matrix used to construct EV</p></dd>
<dt>family</dt><dd><p>the user-provided or default <code>family</code> argument used to fit the model</p></dd>
<dt>formula</dt><dd><p>The model formula provided by the user (not including ESF component)</p></dd>
<dt>slx</dt><dd><p>The <code>slx</code> formula</p></dd>
<dt>re</dt><dd><p>A list containing <code>re</code>,  the random effects (varying intercepts) formula if provided, and
<code>data</code> a data frame with columns <code>id</code>, the grouping variable, and <code>idx</code>, the index values assigned to each group.</p></dd>
<dt>priors</dt><dd><p>Prior specifications.</p></dd>
<dt>scale_params</dt><dd><p>A list with the center and scale parameters returned from the call to <code><a href='https://rdrr.io/r/base/scale.html'>base::scale</a></code> on the model matrix. If <code>centerx = FALSE</code> and <code>scalex = FALSE</code> then it is an empty list.</p></dd>
<dt>ME</dt><dd><p>The <code>ME</code> data list, if one was provided by the user for measurement error models.</p></dd>
<dt>spatial</dt><dd><p>A data frame with the name of the spatial component parameter ("esf") and method ("ESF")</p></dd>
<dt>stanfit</dt><dd><p>an object of class <code>stanfit</code> returned by <code><a href='https://mc-stan.org/rstan/reference/stan.html'>rstan::stan</a></code></p></dd>

</dl>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Eigenvector spatial filtering (ESF) is extensivly covered in Griffith et al. (2019). This function implements the methodology introduced in Donegan et al. (2020), drawing on the Piironen and Vehtari's (2017) regularized horseshoe prior.</p>
<p>ESF models take the spectral decomposition of a transformed spatial connectivity matrix, <code>C</code>. The resulting eigenvectors, <code>EV</code>, are mutually orthogonal and uncorrelated map patterns. ESF decomposes spatial autocorrelation into a linear combination of various patterns, typically at different scales (such as local, regional, and global trends). By adding a spatial filter to a regression model, any spatial autocorrelation is shifted from the residuals to the spatial filter. The spatail filter is <code>EV * beta_ev</code>, where <code>beta_ev</code> is a vector of coefficients.</p>
<p>ESF decomposes the data into a global mean, <code>alpha</code>, global patterns contributed by covariates, <code>X * beta</code>, spatial trends, <code>EV * beta_ev</code>, and residual variation. Thus, for <code>family=gaussian()</code>,</p><pre>                         Y ~ Gauss(alpha + X * beta + EV * beta_ev, sigma).
</pre>

<p>An ESF component can be incorporated into the linear predictor of any generalized linear model. For example, a spatial Poisson model for rare disease incidence may be specified as follows:</p><pre>                          <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>Poisson</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>offset</span> <span class='op'>+</span> <span class='va'>Mu</span><span class='op'>)</span><span class='op'>)</span>
                          <span class='va'>Mu</span> <span class='op'>=</span> <span class='va'>alpha</span> <span class='op'>+</span> <span class='va'>A</span> <span class='op'>+</span> <span class='va'>EV</span> <span class='op'>*</span> <span class='va'>beta_ev</span>
                          <span class='va'>A</span> <span class='op'>~</span> <span class='fu'>Guass</span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>tau</span><span class='op'>)</span>
                          <span class='va'>tau</span> <span class='op'>~</span> <span class='fu'>student</span><span class='op'>(</span><span class='fl'>20</span>, <span class='fl'>0</span>, <span class='fl'>2</span><span class='op'>)</span>
                          <span class='va'>beta_ev</span> <span class='op'>~</span> <span class='fu'>horseshoe</span><span class='op'>(</span><span class='va'>.</span><span class='op'>)</span>
</pre>

<p>The <a href='spatial.html'>spatial</a> method will return <code>EV * beta</code>.</p>
<p>The model can also be extended to the space-time domain; see <a href='shape2mat.html'>shape2mat</a> to specify a space-time connectivity matrix.</p>
<p>The coefficients <code>beta_ev</code> are assigned the regularized horseshoe prior (Piironen and Vehtari, 2017), resulting in a relatively sparse model specification. In addition, numerous eigenvectors are automatically dropped because they represent trace amounts of spatial autocorrelation (this is controlled by the <code>threshold</code> argument). By default, <code>stan_esf</code> will drop all eigenvectors representing negative spatial autocorrelation patterns. You can change this behavior using the <code>nsa</code> argument.</p>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Connor Donegan, <a href='mailto:Connor.Donegan@UTDallas.edu'>Connor.Donegan@UTDallas.edu</a></p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ggplot2.tidyverse.org'>ggplot2</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://r-spatial.github.io/sf/'>sf</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://mc-stan.org/bayesplot/'>bayesplot</a></span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>sentencing</span><span class='op'>)</span>

<span class='co'># spatial weights matrix with binary coding scheme</span>
<span class='va'>C</span> <span class='op'>&lt;-</span> <span class='fu'><a href='shape2mat.html'>shape2mat</a></span><span class='op'>(</span><span class='va'>sentencing</span>, style <span class='op'>=</span> <span class='st'>"B"</span><span class='op'>)</span>

<span class='co'># log-expected number of sentences</span>
<span class='co'>## expected counts are based on county racial composition and mean sentencing rates</span>
<span class='va'>log_e</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>sentencing</span><span class='op'>$</span><span class='va'>expected_sents</span><span class='op'>)</span>

<span class='co'># fit spatial Poisson model with ESF + unstructured 'random effects'</span>
<span class='va'>fit.esf</span> <span class='op'>&lt;-</span> <span class='fu'>stan_esf</span><span class='op'>(</span><span class='va'>sents</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/offset.html'>offset</a></span><span class='op'>(</span><span class='va'>log_e</span><span class='op'>)</span>,
                   re <span class='op'>=</span> <span class='op'>~</span> <span class='va'>name</span>,
                   family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>poisson</a></span><span class='op'>(</span><span class='op'>)</span>,
                   data <span class='op'>=</span> <span class='va'>sentencing</span>,
                   C <span class='op'>=</span> <span class='va'>C</span>,
                   refresh <span class='op'>=</span> <span class='fl'>0</span>
<span class='op'>)</span>

<span class='co'># spatial diagnostics </span>
<span class='fu'><a href='sp_diag.html'>sp_diag</a></span><span class='op'>(</span><span class='va'>fit.esf</span>, <span class='va'>sentencing</span><span class='op'>)</span>

<span class='co'># plot marginal posterior distributions of beta_ev (eigenvector coefficients)</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>fit.esf</span>, pars <span class='op'>=</span> <span class='st'>"beta_ev"</span><span class='op'>)</span>

<span class='co'># plot the marginal posterior distributions of the spatial filter (ESF * beta_ev)</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>fit.esf</span>, pars <span class='op'>=</span> <span class='st'>"beta_ev"</span><span class='op'>)</span>

<span class='co'># posterior predictive distribution</span>
<span class='va'>yrep</span> <span class='op'>&lt;-</span> <span class='fu'><a href='posterior_predict.html'>posterior_predict</a></span><span class='op'>(</span><span class='va'>fit.esf</span>, samples <span class='op'>=</span> <span class='fl'>75</span><span class='op'>)</span>
<span class='va'>y</span> <span class='op'>&lt;-</span> <span class='va'>sentencing</span><span class='op'>$</span><span class='va'>sents</span>
<span class='fu'>bayesplot</span><span class='fu'>::</span><span class='fu'><a href='https://mc-stan.org/bayesplot/reference/PPC-distributions.html'>ppc_dens_overlay</a></span><span class='op'>(</span><span class='va'>y</span>, <span class='va'>yrep</span><span class='op'>)</span> 

<span class='co'># map the spatial filter</span>
<span class='va'>sp.filter</span> <span class='op'>&lt;-</span> <span class='fu'><a href='spatial.html'>spatial</a></span><span class='op'>(</span><span class='va'>fit.esf</span><span class='op'>)</span><span class='op'>$</span><span class='va'>mean</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span><span class='va'>sentencing</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='va'>sp.filter</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_gradient.html'>scale_fill_gradient2</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># calculate log-standardized sentencing ratios (log-SSRs)</span>
<span class='va'>f</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/fitted.values.html'>fitted</a></span><span class='op'>(</span><span class='va'>fit.esf</span><span class='op'>)</span><span class='op'>$</span><span class='va'>mean</span>
<span class='va'>SSR</span> <span class='op'>&lt;-</span>  <span class='va'>f</span> <span class='op'>/</span> <span class='va'>sentencing</span><span class='op'>$</span><span class='va'>expected_sents</span>
<span class='va'>log.SSR</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span> <span class='va'>SSR</span>, base <span class='op'>=</span> <span class='fl'>2</span> <span class='op'>)</span>

<span class='co'># map the log-SSRs</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span><span class='va'>sentencing</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='va'>log.SSR</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_gradient.html'>scale_fill_gradient2</a></span><span class='op'>(</span>
   midpoint <span class='op'>=</span> <span class='fl'>0</span>,
   name <span class='op'>=</span> <span class='cn'>NULL</span>,
   breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span>, by <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span>
 <span class='op'>)</span> <span class='op'>+</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>"Log-Standardized Sentencing Ratios"</span>,
      subtitle <span class='op'>=</span> <span class='st'>"log( Fitted/Expected ), base 2"</span>
 <span class='op'>)</span> <span class='op'>+</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_void</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
 <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>
   legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>,
   legend.key.height <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/unit.html'>unit</a></span><span class='op'>(</span><span class='fl'>0.35</span>, <span class='st'>"cm"</span><span class='op'>)</span>,
   legend.key.width <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/unit.html'>unit</a></span><span class='op'>(</span><span class='fl'>1.5</span>, <span class='st'>"cm"</span><span class='op'>)</span>
 <span class='op'>)</span>

<span class='op'>}</span> 

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


