<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Spatial filtering — stan_esf • geostan</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial filtering — stan_esf"><meta property="og:description" content="Fit a spatial regression model using eigenvector spatial filtering (ESF)."><meta property="og:image" content="https://connordonegan.github.io/geostan/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/ConnorDonegan/geostan/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Spatial filtering</h1>
    <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/geostan/blob/HEAD/R/stan_esf.R" class="external-link"><code>R/stan_esf.R</code></a></small>
    <div class="hidden name"><code>stan_esf.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Fit a spatial regression model using eigenvector spatial filtering (ESF).</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">stan_esf</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  <span class="va">slx</span>,</span>
<span>  <span class="va">re</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">C</span>,</span>
<span>  EV <span class="op">=</span> <span class="fu"><a href="make_EV.html">make_EV</a></span><span class="op">(</span><span class="va">C</span>, nsa <span class="op">=</span> <span class="va">nsa</span>, threshold <span class="op">=</span> <span class="va">threshold</span><span class="op">)</span>,</span>
<span>  nsa <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ME <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  centerx <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">censor_point</span>,</span>
<span>  prior_only <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  keep_all <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  slim <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  drop <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  pars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  control <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="source">
    <h2>Source</h2>
    <p>Chun, Y., D. A. Griffith, M. Lee and P. Sinha (2016). Eigenvector selection with stepwise regression techniques to construct eigenvector spatial filters. <em>Journal of Geographical Systems</em>, 18(1), 67-85. <a href="https://doi.org/10.1007/s10109-015-0225-3" class="external-link">doi:10.1007/s10109-015-0225-3</a>
.</p>
<p>Dray, S., P. Legendre &amp; P. R. Peres-Neto (2006). Spatial modelling: a comprehensive framework for principal coordinate analysis of neighbour matrices (PCNM). <em>Ecological Modeling</em>, 196(3-4), 483-493.</p>
<p>Donegan, C., Y. Chun and A. E. Hughes (2020). Bayesian estimation of spatial filters with Moran’s Eigenvectors and hierarchical shrinkage priors. <em>Spatial Statistics</em>. <a href="https://doi.org/10.1016/j.spasta.2020.100450" class="external-link">doi:10.1016/j.spasta.2020.100450</a>
 (open access: <a href="https://doi.org/10.31219/osf.io/fah3z" class="external-link">doi:10.31219/osf.io/fah3z</a>
).</p>
<p>Griffith, Daniel A., and P. R. Peres-Neto (2006). Spatial modeling in ecology: the flexibility of eigenfunction spatial analyses. <em>Ecology</em> 87(10), 2603-2613.</p>
<p>Griffith, D., and Y. Chun (2014). Spatial autocorrelation and spatial filtering, Handbook of Regional Science. Fischer, MM and Nijkamp, P. eds.</p>
<p>Griffith, D., Chun, Y. and Li, B. (2019). <em>Spatial Regression Analysis Using Eigenvector Spatial Filtering</em>. Elsevier.</p>
<p>Piironen, J and A. Vehtari (2017). Sparsity information and regularization in the horseshoe and other shrinkage priors. In <em>Electronic Journal of Statistics</em>, 11(2):5018-5051.</p>
    </div>
    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>formula</dt>
<dd><p>A model formula, following the R <code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></code> syntax. Binomial models are specified by setting the left hand side of the equation to a data frame of successes and failures, as in <code>cbind(successes, failures) ~ x</code>.</p></dd>


<dt>slx</dt>
<dd><p>Formula to specify any spatially-lagged covariates. As in, <code>~ x1 + x2</code> (the intercept term will be removed internally). When setting priors for <code>beta</code>, remember to include priors for any SLX terms.</p></dd>


<dt>re</dt>
<dd><p>To include a varying intercept (or "random effects") term, <code>alpha_re</code>, specify the grouping variable here using formula syntax, as in <code>~ ID</code>. Then, <code>alpha_re</code> is a vector of parameters added to the linear predictor of the model, and:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>alpha_re <span class="op">~</span><span class="st"> </span><span class="kw">N</span>(<span class="dv">0</span>, alpha_tau)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>alpha_tau <span class="op">~</span><span class="st"> </span><span class="kw">Student_t</span>(d.f., location, scale).</span></code></pre><p></p></div></dd>


<dt>data</dt>
<dd><p>A <code>data.frame</code> or an object coercible to a data frame by <code>as.data.frame</code> containing the model data.</p></dd>


<dt>C</dt>
<dd><p>Spatial connectivity matrix. This will be used to calculate eigenvectors if <code>EV</code> is not provided by the user. See <code><a href="shape2mat.html">shape2mat</a></code>. Use of row-normalization (as in `<code>shape2mat(shape, 'W')</code> is not recommended for creating <code>EV</code>. Matrix <code>C</code> will also be used ('as is') to create any user-specified <code>slx</code> terms.</p></dd>


<dt>EV</dt>
<dd><p>A matrix of eigenvectors from any (transformed) connectivity matrix, presumably spatial or network-based (see <code><a href="make_EV.html">make_EV</a></code>). If <code>EV</code> is provided, still also provide a spatial weights matrix <code>C</code> for other purposes; <code>threshold</code> and <code>nsa</code> are ignored for user provided <code>EV</code>.</p></dd>


<dt>nsa</dt>
<dd><p>Include eigenvectors representing negative spatial autocorrelation? Defaults to <code>nsa = FALSE</code>. This is ignored if <code>EV</code> is provided.</p></dd>


<dt>threshold</dt>
<dd><p>Eigenvectors with standardized Moran coefficient values below this <code>threshold</code> value will be excluded from the candidate set of eigenvectors, <code>EV</code>. This defaults to <code>threshold = 0.25</code>, and is ignored if <code>EV</code> is provided.</p></dd>


<dt>family</dt>
<dd><p>The likelihood function for the outcome variable. Current options are <code>family = gaussian()</code>, <code><a href="priors.html">student_t()</a></code> and <code>poisson(link = "log")</code>, and <code>binomial(link = "logit")</code>.</p></dd>


<dt>prior</dt>
<dd><p>A named list of parameters for prior distributions (see <code><a href="priors.html">priors</a></code>):</p><dl><dt>intercept</dt>
<dd><p>The intercept is assigned a Gaussian prior distribution (see <code><a href="priors.html">normal</a></code></p></dd>
.

<dt>beta</dt>
<dd><p>Regression coefficients are assigned Gaussian prior distributions. Variables must follow their order of appearance in the model <code>formula</code>. Note that if you also use <code>slx</code> terms (spatially lagged covariates), and you use custom priors for <code>beta</code>, then you have to provide priors for the slx terms. Since slx terms are <em>prepended</em> to the design matrix, the prior for the slx term will be listed first.</p></dd>


<dt>sigma</dt>
<dd><p>For <code>family = gaussian()</code> and <code>family = student_t()</code> models, the scale parameter, <code>sigma</code>, is assigned a (half-) Student's t prior distribution. The half-Student's t prior for <code>sigma</code> is constrained to be positive.</p></dd>


<dt>nu</dt>
<dd><p><code>nu</code> is the degrees of freedom parameter in the Student's t likelihood (only used when <code>family = student_t()</code>). <code>nu</code> is assigned a gamma prior distribution. The default prior is <code>prior = list(nu = gamma2(alpha = 3, beta = 0.2))</code>.</p></dd>


<dt>tau</dt>
<dd><p>The scale parameter for random effects, or varying intercepts, terms. This scale parameter, <code>tau</code>, is assigned a half-Student's t prior. To set this, use, e.g., <code>prior = list(tau = student_t(df = 20, location = 0, scale = 20))</code>.</p></dd>


<dt>beta_ev</dt>
<dd><p>The eigenvector coefficients are assigned the horseshoe prior (Piironen and Vehtari, 2017), parameterized by <code>global_scale</code> (to control overall prior sparsity), plus the degrees of freedom and scale of a Student's t model for any large coefficients (see <code><a href="priors.html">priors</a></code>). To allow the spatial filter to account for a greater amount of spatial autocorrelation (i.e., if you find the residuals contain spatial autocorrelation), increase the global scale parameter (to a maximum of <code>global_scale = 1</code>).</p></dd>


</dl></dd>


<dt>ME</dt>
<dd><p>To model observational uncertainty (i.e. measurement or sampling error) in any or all of the covariates, provide a list of data as constructed by the <code><a href="prep_me_data.html">prep_me_data</a></code> function.</p></dd>


<dt>centerx</dt>
<dd><p>To center predictors on their mean values, use <code>centerx = TRUE</code>. If the ME argument is used, the modeled covariate (i.e., latent variable), rather than the raw observations, will be centered. When using the ME argument, this is the recommended method for centering the covariates.</p></dd>


<dt>censor_point</dt>
<dd><p>Integer value indicating the maximum censored value; this argument is for modeling censored (suppressed) outcome data, typically disease case counts or deaths. For example, the US Centers for Disease Control and Prevention censors (does not report) death counts that are nine or fewer, so if you're using CDC WONDER mortality data you could provide <code>censor_point = 9</code>.</p></dd>


<dt>prior_only</dt>
<dd><p>Draw samples from the prior distributions of parameters only.</p></dd>


<dt>chains</dt>
<dd><p>Number of MCMC chains to estimate. Default <code>chains = 4</code>.</p></dd>


<dt>iter</dt>
<dd><p>Number of samples per chain. Default <code>iter = 2000</code>.</p></dd>


<dt>refresh</dt>
<dd><p>Stan will print the progress of the sampler every <code>refresh</code> number of samples. Defaults to <code>500</code>; set <code>refresh=0</code> to silence this.</p></dd>


<dt>keep_all</dt>
<dd><p>If <code>keep_all = TRUE</code> then samples for all parameters in the Stan model will be kept; this is necessary if you want to do model comparison with Bayes factors and the <code>bridgesampling</code> package.</p></dd>


<dt>slim</dt>
<dd><p>If <code>slim = TRUE</code>, then the Stan model will not collect the most memory-intensive parameters (including n-length vectors of fitted values, log-likelihoods, and ME-modeled covariate values). This will disable many convenience functions that are otherwise available for fitted <code>geostan</code> models, such as the extraction of residuals, fitted values, and spatial trends, WAIC, and spatial diagnostics, and ME diagnostics; many quantities of interest, such as fitted values and spatial trends, can still be calculated manually using given parameter estimates. The "slim" option is useful for data-intensive routines, such as regression with raster data, Monte Carlo studies, and measurement error models. For more control over which parameters are kept or dropped, use the <code>drop</code> argument instead of <code>slim</code>.</p></dd>


<dt>drop</dt>
<dd><p>Provide a vector of character strings to specify the names of any parameters that you do not want MCMC samples for. Dropping parameters in this way can improve sampling speed and reduce memory usage. The following parameter vectors can potentially be dropped from ESF models:</p><dl><dt>fitted</dt>
<dd><p>The N-length vector of fitted values</p></dd>

<dt>alpha_re</dt>
<dd><p>Vector of 'random effects'/varying intercepts.</p></dd>

<dt>x_true</dt>
<dd><p>N-length vector of 'latent'/modeled covariate values created for measurement error (ME) models.</p></dd>

<dt>esf</dt>
<dd><p>The N-length eigenvector spatial filter.</p></dd>

<dt>beta_ev</dt>
<dd><p>The vector of coefficients for the eigenvectors.</p></dd>


</dl><p>If <code>slim = TRUE</code>, then <code>drop</code> will be ignored.</p></dd>


<dt>pars</dt>
<dd><p>Optional; specify any additional parameters you'd like stored from the Stan model.</p></dd>


<dt>control</dt>
<dd><p>A named list of parameters to control the sampler's behavior. See <a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">stan</a> for details.</p></dd>


<dt>quiet</dt>
<dd><p>By default, any prior distributions that have not been assigned by the user are printed to the console. If <code>quiet = TRUE</code>, these will not be printed.</p></dd>


<dt>...</dt>
<dd><p>Other arguments passed to <a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a>.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>An object of class class <code>geostan_fit</code> (a list) containing:</p><dl><dt>summary</dt>
<dd><p>Summaries of the main parameters of interest; a data frame</p></dd>

<dt>diagnostic</dt>
<dd><p>Residual spatial autocorrelation as measured by the Moran coefficient.</p></dd>

<dt>data</dt>
<dd><p>a data frame containing the model data</p></dd>

<dt>EV</dt>
<dd><p>A matrix of eigenvectors created with <code>w</code> and <code><a href="make_EV.html">geostan::make_EV</a></code></p></dd>

<dt>C</dt>
<dd><p>The spatial weights matrix used to construct EV</p></dd>

<dt>family</dt>
<dd><p>the user-provided or default <code>family</code> argument used to fit the model</p></dd>

<dt>formula</dt>
<dd><p>The model formula provided by the user (not including ESF component)</p></dd>

<dt>slx</dt>
<dd><p>The <code>slx</code> formula</p></dd>

<dt>re</dt>
<dd><p>A list containing <code>re</code>,  the random effects (varying intercepts) formula if provided, and
<code>data</code> a data frame with columns <code>id</code>, the grouping variable, and <code>idx</code>, the index values assigned to each group.</p></dd>

<dt>priors</dt>
<dd><p>Prior specifications.</p></dd>

<dt>x_center</dt>
<dd><p>If covariates are centered internally (<code>centerx = TRUE</code>), then <code>x_center</code> is a numeric vector of the values on which covariates were centered.</p></dd>

<dt>ME</dt>
<dd><p>The <code>ME</code> data list, if one was provided by the user for measurement error models.</p></dd>

<dt>spatial</dt>
<dd><p>A data frame with the name of the spatial component parameter ("esf") and method ("ESF")</p></dd>

<dt>stanfit</dt>
<dd><p>an object of class <code>stanfit</code> returned by <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">rstan::stan</a></code></p></dd>


</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>Eigenvector spatial filtering (ESF) is a method for spatial regression analysis. ESF is extensively covered in Griffith et al. (2019). This function implements the methodology introduced in Donegan et al. (2020), which uses Piironen and Vehtari's (2017) regularized horseshoe prior.</p>
<p>ESF decomposes spatial autocorrelation into a linear combination of various patterns, typically at different scales (such as local, regional, and global trends). By adding a spatial filter to a regression model, these spatial autocorrelation patterns are shifted from the residuals to the spatial filter. ESF models take the spectral decomposition of a transformed spatial connectivity matrix, \(C\). The resulting eigenvectors, \(E\), are mutually orthogonal and uncorrelated map patterns. The spatial filter equals \(E \beta_{E}\) where \(\beta_{E}\) is a vector of coefficients.</p>
<p>ESF decomposes the data into a global mean, \(\alpha\), global patterns contributed by covariates \(X \beta\), spatial trends \(E \beta_{E}\), and residual variation. Thus, for <code>family=gaussian()</code>,</p>
<p>$$
y \sim Gauss(\alpha + X * \beta + E \beta_{E}, \sigma).
$$</p>
<p>An ESF component can be incorporated into the linear predictor of any generalized linear model. For example, a spatial Poisson model for rare disease incidence may be specified as follows:</p>
<p>$$y \sim Poisson(e^{O + \mu})$$
$$\mu = \alpha + E \beta_{E} + A $$
$$ A \sim Guass(0, \tau) $$
$$ \tau \sim student(20, 0, 2) $$
$$ \beta_{E} \sim horseshoe(.) $$</p>
<p>The form of this model is similar to the BYM model (see <a href="stan_icar.html">stan_icar</a>), in the sense that it contains a spatially structured trend term (\(E \beta_{E}\)) and an unstructured ('random effects') term (\(A\)).</p>
<p>The <a href="resid_geostan_fit.html">spatial.geostan_fit</a> method will return \(E \beta_{E}\).</p>
<p>The model can also be extended to the space-time domain; see <a href="shape2mat.html">shape2mat</a> to specify a space-time connectivity matrix.</p>
<p>The coefficients \(\beta_{E}\) are assigned the regularized horseshoe prior (Piironen and Vehtari, 2017), resulting in a relatively sparse model specification. In addition, numerous eigenvectors are automatically dropped because they represent trace amounts of spatial autocorrelation (this is controlled by the <code>threshold</code> argument). By default, <code>stan_esf</code> will drop all eigenvectors representing negative spatial autocorrelation patterns. You can change this behavior using the <code>nsa</code> argument.</p><div class="section">
<h3 id="additional-functionality">Additional functionality<a class="anchor" aria-label="anchor" href="#additional-functionality"></a></h3>


<p>The CAR models can also incorporate spatially-lagged covariates, measurement/sampling error in covariates (particularly when using small area survey estimates as covariates), missing outcome data, and censored outcomes (such as arise when a disease surveillance system suppresses data for privacy reasons). For details on these options, please see the Details section in the documentation for <a href="stan_glm.html">stan_glm</a>.</p>
</div>

    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Connor Donegan, <a href="mailto:connor.donegan@gmail.com">connor.donegan@gmail.com</a></p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># \donttest{</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">sentencing</span><span class="op">)</span></span>
<span><span class="co"># spatial weights matrix with binary coding scheme</span></span>
<span><span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">sentencing</span>, style <span class="op">=</span> <span class="st">"B"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># expected number of sentences</span></span>
<span><span class="va">log_e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sentencing</span><span class="op">$</span><span class="va">expected_sents</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit spatial Poisson model with ESF + unstructured 'random effects'</span></span>
<span><span class="va">fit.esf</span> <span class="op">&lt;-</span> <span class="fu">stan_esf</span><span class="op">(</span><span class="va">sents</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_e</span><span class="op">)</span>,</span>
<span>                   re <span class="op">=</span> <span class="op">~</span> <span class="va">name</span>,</span>
<span>                   family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">sentencing</span>,</span>
<span>                   C <span class="op">=</span> <span class="va">C</span>, </span>
<span>                   chains <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">800</span><span class="op">)</span> <span class="co"># for speed only</span></span>
<span></span>
<span><span class="co"># spatial diagnostics </span></span>
<span><span class="fu"><a href="sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">fit.esf</span>, <span class="va">sentencing</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot marginal posterior distributions of beta_ev (eigenvector coefficients)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.esf</span>, pars <span class="op">=</span> <span class="st">"beta_ev"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate log-standardized incidence ratios (SIR)</span></span>
<span><span class="co">#  # SIR = observed/exected number of cases</span></span>
<span><span class="co"># in this case, prison sentences</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit.esf</span>, rates <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span></span>
<span><span class="va">SSR</span> <span class="op">&lt;-</span>  <span class="va">f</span> <span class="op">/</span> <span class="va">sentencing</span><span class="op">$</span><span class="va">expected_sents</span></span>
<span><span class="va">log.SSR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span> <span class="va">SSR</span>, base <span class="op">=</span> <span class="fl">2</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># map the log-SSRs</span></span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sentencing</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">log.SSR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span></span>
<span>    midpoint <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Log-Standardized Sentencing Ratios"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"log( Fitted/Expected ), base 2"</span></span>
<span> <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># }</span></span></code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

