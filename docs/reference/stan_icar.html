<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Intrinsic autoregressive models — stan_icar • geostan</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Intrinsic autoregressive models — stan_icar"><meta property="og:description" content="The intrinsic conditional auto-regressive (ICAR) model for spatial count data. Options include the BYM model, the BYM2 model, and a solo ICAR term."><meta property="og:image" content="https://connordonegan.github.io/geostan/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116873024-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116873024-1');
</script></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/ConnorDonegan/geostan/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Intrinsic autoregressive models</h1>
    <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/geostan/blob/HEAD/R/stan_icar.R" class="external-link"><code>R/stan_icar.R</code></a></small>
    <div class="hidden name"><code>stan_icar.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>The intrinsic conditional auto-regressive (ICAR) model for spatial count data. Options include the BYM model, the BYM2 model, and a solo ICAR term.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">stan_icar</span><span class="op">(</span>
  <span class="va">formula</span>,
  <span class="va">slx</span>,
  <span class="va">re</span>,
  <span class="va">data</span>,
  <span class="va">C</span>,
  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,
  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"icar"</span>, <span class="st">"bym"</span>, <span class="st">"bym2"</span><span class="op">)</span>,
  scale_factor <span class="op">=</span> <span class="cn">NULL</span>,
  prior <span class="op">=</span> <span class="cn">NULL</span>,
  ME <span class="op">=</span> <span class="cn">NULL</span>,
  centerx <span class="op">=</span> <span class="cn">FALSE</span>,
  <span class="va">censor_point</span>,
  prior_only <span class="op">=</span> <span class="cn">FALSE</span>,
  chains <span class="op">=</span> <span class="fl">4</span>,
  iter <span class="op">=</span> <span class="fl">2000</span>,
  refresh <span class="op">=</span> <span class="fl">500</span>,
  keep_all <span class="op">=</span> <span class="cn">FALSE</span>,
  pars <span class="op">=</span> <span class="cn">NULL</span>,
  control <span class="op">=</span> <span class="cn">NULL</span>,
  <span class="va">...</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div id="source">
    <h2>Source</h2>
    <p>Besag, J. (1974). Spatial interaction and the statistical analysis of lattice systems. <em>Journal of the Royal Statistical Society: Series B (Methodological)</em>, 36(2), 192-225.</p>
<p>Besag, J., York, J., &amp; Mollié, A. (1991). Bayesian image restoration, with two applications in spatial statistics. <em>Annals of the Institute of Statistical Mathematics</em>, 43(1), 1-20.</p>
<p>Donegan, Connor. 2021. Flexible functions for ICAR, BYM, and BYM2 models in Stan. Code repository. <a href="https://github.com/ConnorDonegan/Stan-IAR" class="external-link">https://github.com/ConnorDonegan/Stan-IAR</a></p>
<p>Donegan, Connor and Chun, Yongwan and Griffith, Daniel A. (2021). Modeling community health with areal data: Bayesian inference with survey standard errors and spatial structure. <em>Int. J. Env. Res. and Public Health</em> 18 (13): 6856. DOI: 10.3390/ijerph18136856 Data and code: <a href="https://github.com/ConnorDonegan/survey-HBM" class="external-link">https://github.com/ConnorDonegan/survey-HBM</a>.</p>
<p>Donegan, Connor (2021). Spatial conditional autoregressive models in Stan. <em>OSF Preprints</em>. <a href="https://doi.org/10.31219/osf.io/3ey65" class="external-link">doi:10.31219/osf.io/3ey65</a>
.</p>
<p>Freni-Sterrantino, Anna, Massimo Ventrucci, and Håvard Rue. 2018. A Note on Intrinsic Conditional Autoregressive Models for Disconnected Graphs. <em>Spatial and Spatio-Temporal Epidemiology</em>, 26: 25–34.</p>
<p>Morris, M., Wheeler-Martin, K., Simpson, D., Mooney, S. J., Gelman, A., &amp; DiMaggio, C. (2019). Bayesian hierarchical spatial models: Implementing the Besag York Mollié model in stan. <em>Spatial and spatio-temporal epidemiology</em>, 31, 100301.</p>
<p>Riebler, A., Sorbye, S. H., Simpson, D., &amp; Rue, H. (2016). An intuitive Bayesian spatial model for disease mapping that accounts for scaling. <em>Statistical Methods in Medical Research</em>, 25(4), 1145-1165.</p>
    </div>
    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>formula</dt>
<dd><p>A model formula, following the R <a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a> syntax. Binomial models can be specified by setting the left hand side of the equation to a data frame of successes and failures, as in <code>cbind(successes, failures) ~ x</code>.</p></dd>
<dt>slx</dt>
<dd><p>Formula to specify any spatially-lagged covariates. As in, <code>~ x1 + x2</code> (the intercept term will be removed internally). When setting priors for <code>beta</code>, remember to include priors for any SLX terms.</p></dd>
<dt>re</dt>
<dd><p>To include a varying intercept (or "random effects") term, <code>alpha_re</code>, specify the grouping variable here using formula syntax, as in <code>~ ID</code>. Then, <code>alpha_re</code> is a vector of parameters added to the linear predictor of the model, and:</p><div class="sourceCode"><pre><code>alpha_re ~ N(0, alpha_tau)
alpha_tau ~ Student_t(d.f., location, scale).
</code></pre></div>

<p>Before using this term, read the <code>Details</code> section and the <code>type</code> argument. Specifically, if you use <code>type = bym</code>, then an observational-level <code>re</code> term is already included in the model. (Similar for <code>type = bym2</code>.)</p></dd>
<dt>data</dt>
<dd><p>A <code>data.frame</code> or an object coercible to a data frame by <code>as.data.frame</code> containing the model data.</p></dd>
<dt>C</dt>
<dd><p>Spatial connectivity matrix which will be used to construct an edge list for the ICAR model, and to calculate residual spatial autocorrelation as well as any user specified <code>slx</code> terms. It will automatically be row-standardized before calculating <code>slx</code> terms. <code>C</code> must be a binary symmetric <code>n x n</code> matrix.</p></dd>
<dt>family</dt>
<dd><p>The likelihood function for the outcome variable. Current options are <code>binomial(link = "logit")</code> and <code>poisson(link = "log")</code>.</p></dd>
<dt>type</dt>
<dd><p>Defaults to "icar" (partial pooling of neighboring observations through parameter <code>phi</code>); specify "bym" to add a second parameter vector <code>theta</code> to perform partial pooling across all observations; specify "bym2" for the innovation introduced by Riebler et al. (2016). See <code>Details</code> for more information.</p></dd>
<dt>scale_factor</dt>
<dd><p>For the BYM2 model, optional. If missing, this will be set to a vector of ones. See <code>Details</code>.</p></dd>
<dt>prior</dt>
<dd><p>A named list of parameters for prior distributions (see <code><a href="priors.html">priors</a></code>):</p><dl><dt>intercept</dt>
<dd><p>The intercept is assigned a Gaussian prior distribution (see <code><a href="priors.html">normal</a></code></p></dd>
.

<dt>beta</dt>
<dd><p>Regression coefficients are assigned Gaussian prior distributions. Variables must follow their order of appearance in the model <code>formula</code>. Note that if you also use <code>slx</code> terms (spatially lagged covariates), and you use custom priors for <code>beta</code>, then you have to provide priors for the slx terms. Since slx terms are <em>prepended</em> to the design matrix, the prior for the slx term will be listed first.</p></dd>


<dt>sigma</dt>
<dd><p>For <code>family = gaussian()</code> and <code>family = student_t()</code> models, the scale parameter, <code>sigma</code>, is assigned a (half-) Student's t prior distribution. The half-Student's t prior for <code>sigma</code> is constrained to be positive.</p></dd>


<dt>nu</dt>
<dd><p><code>nu</code> is the degrees of freedom parameter in the Student's t likelihood (only used when <code>family = student_t()</code>). <code>nu</code> is assigned a gamma prior distribution. The default prior is <code>prior = list(nu = gamma(alpha = 3, beta = 0.2))</code>.</p></dd>


<dt>tau</dt>
<dd><p>The scale parameter for random effects, or varying intercepts, terms. This scale parameter, <code>tau</code>, is assigned a half-Student's t prior. To set this, use, e.g., <code>prior = list(tau = student_t(df = 20, location = 0, scale = 20))</code>.</p></dd>


</dl></dd>
<dt>ME</dt>
<dd><p>To model observational uncertainty (i.e. measurement or sampling error) in any or all of the covariates, provide a list of data as constructed by the <code><a href="prep_me_data.html">prep_me_data</a></code> function.</p></dd>
<dt>centerx</dt>
<dd><p>To center predictors on their mean values, use <code>centerx = TRUE</code>. If the ME argument is used, the modeled covariate (i.e., latent variable), rather than the raw observations, will be centered. When using the ME argument, this is the recommended method for centering the covariates.</p></dd>
<dt>censor_point</dt>
<dd><p>Integer value indicating the maximum censored value; this argument is for modeling censored (suppressed) outcome data, typically disease case counts or deaths. For example, the US Centers for Disease Control and Prevention censors (does not report) death counts that are nine or fewer, so if you're using CDC WONDER mortality data you could provide <code>censor_point = 9</code>.</p></dd>
<dt>prior_only</dt>
<dd><p>Draw samples from the prior distributions of parameters only.</p></dd>
<dt>chains</dt>
<dd><p>Number of MCMC chains to estimate.</p></dd>
<dt>iter</dt>
<dd><p>Number of samples per chain. .</p></dd>
<dt>refresh</dt>
<dd><p>Stan will print the progress of the sampler every <code>refresh</code> number of samples; set <code>refresh=0</code> to silence this.</p></dd>
<dt>keep_all</dt>
<dd><p>If <code>keep_all = TRUE</code> then samples for all parameters in the Stan model will be kept; this is necessary if you want to do model comparison with Bayes factors and the <code>bridgesampling</code> package.</p></dd>
<dt>pars</dt>
<dd><p>Optional; specify any additional parameters you'd like stored from the Stan model.</p></dd>
<dt>control</dt>
<dd><p>A named list of parameters to control the sampler's behavior. See <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">stan</a></code> for details.</p></dd>
<dt>...</dt>
<dd><p>Other arguments passed to <a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a>. For multi-core processing, you can use <code>cores = parallel::detectCores()</code>, or run <code>options(mc.cores = parallel::detectCores())</code> first.</p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>An object of class class <code>geostan_fit</code> (a list) containing:</p><dl><dt>summary</dt>
<dd><p>Summaries of the main parameters of interest; a data frame</p></dd>

<dt>diagnostic</dt>
<dd><p>Widely Applicable Information Criteria (WAIC) with a measure of effective number of parameters (<code>eff_pars</code>) and mean log pointwise predictive density (<code>lpd</code>), and mean residual spatial autocorrelation as measured by the Moran coefficient.</p></dd>

<dt>stanfit</dt>
<dd><p>an object of class <code>stanfit</code> returned by <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">rstan::stan</a></code></p></dd>

<dt>data</dt>
<dd><p>a data frame containing the model data</p></dd>

<dt>edges</dt>
<dd><p>The edge list representing all unique sets of neighbors and the weight attached to each pair (i.e., their corresponding element in the connectivity matrix  C</p></dd>

<dt>family</dt>
<dd><p>the user-provided or default <code>family</code> argument used to fit the model</p></dd>

<dt>formula</dt>
<dd><p>The model formula provided by the user (not including ICAR component)</p></dd>

<dt>slx</dt>
<dd><p>The <code>slx</code> formula</p></dd>

<dt>re</dt>
<dd><p>A list with two name elements, <code>formula</code> and <code>Data</code>, containing the formula <code>re</code> and a data frame with columns <code>id</code> (the grouping variable) and <code>idx</code> (the index values assigned to each group).</p></dd>

<dt>priors</dt>
<dd><p>Prior specifications.</p></dd>

<dt>x_center</dt>
<dd><p>If covariates are centered internally (<code>centerx = TRUE</code>), then <code>x_center</code> is a numeric vector of the values on which covariates were centered.</p></dd>

<dt>spatial</dt>
<dd><p>A data frame with the name of the spatial parameter (<code>"phi"</code> if <code>type = "icar"</code> else <code>"convolution"</code>) and method (<code>toupper(type)</code>).</p></dd>


</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>The intrinsic conditional autoregressive (ICAR) model for spatial data was introduced by Besag et al. (1991). The Stan code for the ICAR component of the model and the BYM2 option is from Morris et al. (2019) with adjustments to enable non-binary weights and disconnected graph structures (see Freni-Sterrantino (2018) and Donegan (2021)).</p>
<p>The exact specification depends on the <code>type</code> argument.</p><div class="section">
<h3 id="-icar-">'icar'<a class="anchor" aria-label="anchor" href="#-icar-"></a></h3>


<p>For Poisson models for count data, y, the basic model specification (<code>type = "icar"</code>) is:
$$
y ~ Poisson(e^{O + \mu + \phi}) \\
\phi \sim ICAR(\tau_s) \\
\tau_s \sim Gauss(0, 1)
$$
where \(\mu\) contains an intercept and potentially covariates. The spatial trend \(phi\) has a mean of zero and a single scale parameter \(\tau_s\) (which user's will see printed as the parameter named <code>spatial_scale</code>).</p>
<p>The ICAR prior model is a CAR model that has a spatial autocorrelation parameter \(\rho\) equal to 1 (see <a href="stan_car.html">stan_car</a>). Thus the ICAR prior places high probability on a very smooth spatially (or temporally) varying mean. This is rarely sufficient to model the amount of variation present in social and health data.</p>
</div>

<div class="section">
<h3 id="-bym-">'bym'<a class="anchor" aria-label="anchor" href="#-bym-"></a></h3>


<p>Often, an observational-level random effect term, <code>theta</code>, is added to capture (heterogeneous or unstructured) deviations from \(\mu + \phi\). The combined term is referred to as a convolution term:
\(
 convolution = \phi + \theta.
\)
This is known as the BYM model (Besag et al. 1991), and can be specified using <code>type = "bym"</code>:
\(
y \sim Poisson(e^{O + \mu + \phi + \theta}) \\
\phi \sim ICAR(\tau_s) \\
\theta \sim Gaussian(0, \tau_{ns})
\tau_s \sim Gaussian(0, 1)
\tau_{ns} \sim Gaussian(0, 1)
\)</p>
</div>

<div class="section">
<h3 id="-bym--1">'bym2'<a class="anchor" aria-label="anchor" href="#-bym--1"></a></h3>


<p>Riebler et al. (2016) introduce a variation on the BYM model (<code>type = "bym2"</code>). This specification combines \(\phi\) and \(\theta\) using a mixing parameter \(\rho\) that controls the proportion of the variation that is attributable to the spatially autocorrelated term \(\phi\) rather than the spatially unstructured term \(\theta\). The terms share a single scale parameter:
$$
convolution = [sqrt(\rho * scale_factor) * \tilde{\phi} + sqrt(1 - \rho)  \tilde{\theta}] * \tau_s \\
\tilde{\phi} \sim Gaussian(0, 1) \\
\tilde{\theta} \sim Gaussian(0, 1) \\
\tau_s \sim Gaussian(0, 1)
$$
The terms \(\tilde{\phi}\), \(\tilde{\theta}\) are standard normal deviates, \(\rho\) is restricted to values between zero and one, and the 'scale_factor' is a constant term provided by the user. By default, the 'scale_factor' is equal to one, so that it does nothing. Riebler et al. (2016) argue that the interpretation or meaning of the scale of the ICAR model depends on the graph structure of the connectivity matrix \(C\). This implies that the same prior distribution assigned to \(\tau_s\) will differ in its implications if \(C\) is changed; in other words, the priors are not transportable across models, and models that use the same nominal prior actually have different priors assigned to \(\tau_s\).</p>
<p>Borrowing <code>R</code> code from Morris (2017) and following Freni-Sterrantino et al. (2018), the following <code>R</code> code can be used to create the 'scale_factor' for the BYM2 model (note, this requires the INLA R package), given a spatial adjacency matrix, \(C\):</p><div class="sourceCode"><pre><code><span class="co">## create a list of data for stan_icar</span>
<span class="va">icar.data</span> <span class="op">&lt;-</span> <span class="fu">geostan</span><span class="fu">::</span><span class="fu"><a href="../reference/prep_icar_data.html">prep_icar_data</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span>
<span class="co">## calculate scale_factor for each of k connected group of nodes</span>
<span class="va">k</span> <span class="op">&lt;-</span> <span class="va">icar.data</span><span class="op">$</span><span class="va">k</span>
<span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"numeric"</span>, length <span class="op">=</span> <span class="va">k</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">g.idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">icar.data</span><span class="op">$</span><span class="va">comp_id</span> <span class="op">==</span> <span class="va">j</span><span class="op">)</span> 
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">g.idx</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
       <span class="va">scale_factor</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
       <span class="kw">next</span>
    <span class="op">}</span>    
  <span class="va">Cg</span> <span class="op">&lt;-</span> <span class="va">C</span><span class="op">[</span><span class="va">g.idx</span>, <span class="va">g.idx</span><span class="op">]</span> 
  <span class="va">scale_factor</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">scale_c</span><span class="op">(</span><span class="va">Cg</span><span class="op">)</span> 
<span class="op">}</span></code></pre></div>

<p>This code adjusts for 'islands' or areas with zero neighbors, and it also handles disconnected graph structures (see Donegan 2021). Following Freni-Sterrantino (2018), disconnected components of the graph structure are given their own intercept term; however, this value is added to \(\phi\) automatically inside the Stan model. Therefore, the user never needs to make any adjustments for this term. (If you want to avoid complications from a disconnected graph structure, see <code><a href="stan_car.html">stan_car</a></code>).</p>
<p>Note, the code above requires the <code>scale_c</code> function; it has package dependencies that are not included in <code>geostan</code>. To use <code>scale_c</code>, you have to load the following <code>R</code> function:</p><div class="sourceCode"><pre><code><span class="co">#' compute scaling factor for adjacency matrix, accounting for differences in spatial connectivity </span>
<span class="co">#'</span>
<span class="co">#' @param C connectivity matrix</span>
<span class="co">#'</span>
<span class="co">#' @details</span>
<span class="co">#'</span>
<span class="co">#' Requires the following packages: </span>
<span class="co">#'</span>
<span class="co">#' library(Matrix)</span>
<span class="co">#' library(INLA);</span>
<span class="co">#' library(spdep)</span>
<span class="co">#' library(igraph)</span>
<span class="co">#'  </span>
<span class="co">#' @source</span>
<span class="co">#'</span>
<span class="co">#'   Morris, Mitzi (2017). Spatial Models in Stan: Intrinsic Auto-Regressive Models for Areal Data. &lt;https://mc-stan.org/users/documentation/case-studies/icar_stan.html&gt;</span>
<span class="co">#'</span>
<span class="va">scale_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">{</span>
 <span class="va">geometric_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
 <span class="va">N</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
 <span class="va">Q</span> <span class="op">=</span>  <span class="fu">Diagonal</span><span class="op">(</span><span class="va">N</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">C</span>
 <span class="va">Q_pert</span> <span class="op">=</span> <span class="va">Q</span> <span class="op">+</span> <span class="fu">Diagonal</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span>
 <span class="va">Q_inv</span> <span class="op">=</span> <span class="fu">inla.qinv</span><span class="op">(</span><span class="va">Q_pert</span>, constr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="va">N</span><span class="op">)</span>,e<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
 <span class="va">scaling_factor</span> <span class="op">&lt;-</span> <span class="fu">geometric_mean</span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu">diag</span><span class="op">(</span><span class="va">Q_inv</span><span class="op">)</span><span class="op">)</span> 
 <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">scaling_factor</span><span class="op">)</span> 
<span class="op">}</span></code></pre></div>

</div>

<div class="section">
<h3 id="spatially-lagged-covariates-slx-">Spatially lagged covariates (SLX)<a class="anchor" aria-label="anchor" href="#spatially-lagged-covariates-slx-"></a></h3>


<p>The <code>slx</code> argument is a convenience function for including SLX terms. For example,
$$
 y = W X \gamma + X \beta + \epsilon
$$
where \(W\) is a row-standardized spatial weights matrix (see <a href="shape2mat.html">shape2mat</a>), \(WX\) is the mean neighboring value of \(X\), and \(\gamma\) is a coefficient vector. This specifies a regression with spatially lagged covariates. SLX terms can specified by providing a formula to the <code>slx</code> argument:</p><div class="sourceCode"><pre><code>stan_glm(y ~ x1 + x2, slx = ~ x1 + x2, \...),
</code></pre></div>

<p>which is a shortcut for</p><div class="sourceCode"><pre><code>stan_glm(y ~ I(W \%*\% x1) + I(W \%*\% x2) + x1 + x2, \...)
</code></pre></div>

<p>SLX terms will always be <em>prepended</em> to the design matrix, as above, which is important to know when setting prior distributions for regression coefficients.</p>
<p>For measurement error (ME) models, the SLX argument is the only way to include spatially lagged covariates since the SLX term needs to be re-calculated on each iteration of the MCMC algorithm.</p>
</div>

<div class="section">
<h3 id="measurement-error-me-models">Measurement error (ME) models<a class="anchor" aria-label="anchor" href="#measurement-error-me-models"></a></h3>


<p>The ME models are designed for surveys with spatial sampling designs, such as the American Community Survey (ACS) estimates. Given estimates \(x\), their standard errors \(s\), and the target quantity of interest (i.e., the unknown true value) \(z\), the ME models have one of the the following two specifications, depending on the user input. If a spatial CAR model is specified, then:
$$
 x \sim Gauss(z, s^2) \\
 z \sim Gauss(\mu_z, \Sigma_z) \\
\Sigma_z = (I - \rho C)^{-1} M \\
 \mu_z \sim Gauss(0, 100) \\
 \tau_z \sim Student(10, 0, 40), \tau &gt; 0 \\
 \rho_z \sim uniform(l, u)
 $$
where \(\Sigma\) specifies a spatial conditional autoregressive model with scale parameter \(\tau\) (on the diagonal of \(M\)), and \(l\), \(u\) are the lower and upper bounds that \(\rho\) is permitted to take (which is determined by the extreme eigenvalues of the spatial connectivity matrix \(C\)).</p>
<p>For non-spatial ME models, the following is used instead:
$$
x \sim Gauss(z, s^2) \\
z \sim student(\nu_z, \mu_z, \sigma_z) \\
\nu_z \sim gamma(3, 0.2) \\
\mu_z \sim Gauss(0, 100) \\
\sigma_z \sim student(10, 0, 40).
$$</p>
<p>For strongly skewed variables, such as census tract poverty rates, it can be advantageous to apply a logit transformation to \(z\) before applying the CAR or Student-t prior model. When the <code>logit</code> argument is used, the model becomes:
$$
x \sim Gauss(z, s^2) \\
logit(z) \sim Gauss(\mu_z, \Sigma_z) 
...
$$
and similarly for the Student t model:
$$
x \sim Gauss(z, s^2) \\
logit(z) \sim student(\nu_z, \mu_z, \sigma_z) \\
...
$$</p>
</div>

<div class="section">
<h3 id="censored-counts">Censored counts<a class="anchor" aria-label="anchor" href="#censored-counts"></a></h3>


<p>Vital statistics systems and disease surveillance programs typically suppress case counts when they are smaller than a specific threshold value. In such cases, the observation of a censored count is not the same as a missing value; instead, you are informed that the value is an integer somewhere between zero and the threshold value. For Poisson models (<code>family = poisson())</code>), you can use the <code>censor_point</code> argument to encode this information into your model.</p>
<p>Internally, <code>geostan</code> will keep the index values of each censored observation, and the index value of each of the fully observed outcome values. For all observed counts, the likelihood statement will be:
$$
p(y_i | data, model) = poisson(y_i | \mu_i), 
$$
as usual, where \(\mu_i\) may include whatever spatial terms are present in the model.</p>
<p>For each censored count, the likelihood statement will equal the cumulative Poisson distribution function for values zero through the censor point:
$$
p(y_i | data, model) = \sum_{m=0}^{M} Poisson( m | \mu_i),
$$
where \(M\) is the censor point and \(\mu_i\) again is the fitted value for the \(i^{th}\) observation.</p>
<p>For example, the US Centers for Disease Control and Prevention's CDC WONDER database censors all death counts between 0 and 9. To model CDC WONDER mortality data, you could provide <code>censor_point = 9</code> and then the likelihood statement for censored counts would equal the summation of the Poisson probability mass function over each integer ranging from zero through 9 (inclusive), conditional on the fitted values (i.e., all model parameters). See Donegan (2021) for additional discussion, references, and Stan code.</p>
</div>

    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><a href="shape2mat.html">shape2mat</a>, <a href="stan_car.html">stan_car</a>, <a href="stan_esf.html">stan_esf</a>, <a href="stan_glm.html">stan_glm</a>, <a href="prep_icar_data.html">prep_icar_data</a></p></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Connor Donegan, <a href="mailto:connor.donegan@gmail.com">connor.donegan@gmail.com</a></p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="co"># \donttest{</span>
<span class="co"># for parallel processing of models:</span>
<span class="co">#options(mc.cores = parallel::detectCores())</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">sentencing</span><span class="op">)</span>
<span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">sentencing</span>, <span class="st">"B"</span><span class="op">)</span>
<span class="va">log_e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sentencing</span><span class="op">$</span><span class="va">expected_sents</span><span class="op">)</span>
<span class="va">fit.bym</span> <span class="op">&lt;-</span> <span class="fu">stan_icar</span><span class="op">(</span><span class="va">sents</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_e</span><span class="op">)</span>,
                     family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,
                     data <span class="op">=</span> <span class="va">sentencing</span>,
                     type <span class="op">=</span> <span class="st">"bym"</span>,
                     C <span class="op">=</span> <span class="va">C</span>,
                     chains <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">800</span><span class="op">)</span> <span class="co"># for speed only</span>

<span class="co"># spatial diagnostics</span>
<span class="fu"><a href="sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">fit.bym</span>, <span class="va">sentencing</span><span class="op">)</span>
                                       
<span class="co"># check effective sample size and convergence</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_ess</a></span><span class="op">(</span><span class="va">fit.bym</span><span class="op">$</span><span class="va">stanfit</span><span class="op">)</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_rhat</a></span><span class="op">(</span><span class="va">fit.bym</span><span class="op">$</span><span class="va">stanfit</span><span class="op">)</span>

<span class="co"># calculate log-standardized incidence ratios </span>
<span class="co"># (observed/exected case counts)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>

<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit.bym</span>, rates <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span>
<span class="va">SSR</span> <span class="op">&lt;-</span> <span class="va">f</span> <span class="op">/</span> <span class="va">sentencing</span><span class="op">$</span><span class="va">expected_sents</span>
<span class="va">log.SSR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span> <span class="va">SSR</span>, base <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">sentencing</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">log.SSR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span>
   low <span class="op">=</span> <span class="st">"navy"</span>,
   high <span class="op">=</span> <span class="st">"darkred"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Log-standardized sentencing ratios"</span>,
       subtitle <span class="op">=</span> <span class="st">"log( Fitted/Expected), base 2"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>
   legend.position <span class="op">=</span> <span class="st">"bottom"</span>,
   legend.key.height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.35</span>, <span class="st">"cm"</span><span class="op">)</span>,
   legend.key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="st">"cm"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="co"># }</span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer></div>

  


  

  </body></html>

